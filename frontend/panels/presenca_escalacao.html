<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
    .linhas-topo{display:flex;gap:16px;margin-bottom:16px}
    .col-50{flex:1;min-width:0}
    button{
      padding:6px 10px;border-radius:6px;border:none;cursor:pointer;
      font-weight:bold;text-transform:uppercase;font-size:11px;line-height:1;height:30px;min-width:110px
    }
    .btn-primario{background:#22c55e;color:#022c22}
    .btn-secundario{background:#0ea5e9;color:#0f172a}
    .btn-perigo{background:#ef4444;color:#f9fafb}
    .btn-neutro{background:#f97316;color:#0f172a}
    .btn-chegou{background:#10b981;color:#022c22;min-width:120px}
    .btn-nao-joga{background:#64748b;color:#e5e7eb;min-width:140px}
    .btn-excluir{background:#ef4444;color:#f9fafb;min-width:90px}
    .btn-sair{background:#f97316;color:#0f172a;min-width:70px;height:34px;border-radius:6px;font-size:11px}

    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
    th{background:#111827;color:#f97316;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .status-info{font-size:12px;margin-top:6px;color:#cbd5e1}
    .painel-scroll{overflow-y:auto;max-height:320px}
    .riscado{text-decoration:line-through;opacity:.55}
    .clock-box{font-size:12px;color:#cbd5e1;padding:6px 10px;border:1px solid rgba(148,163,184,0.25);border-radius:10px;background:rgba(15,23,42,0.35);display:inline-block}

    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
    .grid-escalacao table{table-layout:fixed;}
    .grid-escalacao th,.grid-escalacao td{overflow:hidden;text-overflow:ellipsis;}
    .clock-mini{margin:6px 0 4px 0;font-size:12px;color:#fff;opacity:0.9;}
</style>

  <!-- PDF REAL (tabela, não print) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <header>TESOURA - PRESENÇA / ESCALAÇÃO</header>
  <div class="container">

    <div class="linhas-topo">
      <div class="col-50">
        <div class="painel">
          <h2>Jogadores (todos)</h2>
          <div class="status-info">Clique em <b>CHEGOU AGORA</b> quando o jogador chegar.</div>
          <div id="status-jogadores" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th>APELIDO</th>
                  <th style="width:170px">CHEGOU AGORA</th>
                </tr>
              </thead>
              <tbody id="tbody-jogadores-todos"></tbody>
            </table>
          </div>
          <div class="status-info" id="total-jogadores"></div>
        </div>
      </div>

      <div class="col-50">
        <div class="painel painel-presenca">
          <h2>Presença hoje</h2>

          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div class="status-info" id="status-presenca">Carregando...</div>
            <div>
              <span class="clock-box" id="data-jogo-box">Data do jogo: --/--/----</span>
              <span class="clock-box" style="margin-left:8px" id="hora-escalacao-box">Horário da escalação: 06:20</span>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button id="btn-limpar-hoje" class="btn-perigo">Limpar hoje</button>
            <button id="btn-escalar-1t" class="btn-primario">Escalar 1º tempo</button>

            <!-- marcador pedido: acima do desfazer 1T -->
            <div style="display:flex;flex-direction:column;gap:6px">
              <div class="clock-box" id="agora-1t">Hora agora: --:--</div>
              <button id="btn-desfazer-1t" class="btn-neutro">Desfazer 1º tempo</button>
            </div>

            <button id="btn-baixar-presenca" class="btn-neutro">Baixar PDF</button>
          </div>

          <div class="painel-scroll" style="margin-top:10px">
            <table id="tbl-presenca">
              <thead>
                <tr>
                  <th style="width:60px">ID</th>
                  <th style="width:70px">ORDEM</th>
                  <th>APELIDO</th>
                  <th style="width:90px">HORA</th>
                  <th style="width:110px">OBS</th>
                  <th style="width:160px">NÃO VAI JOGAR</th>
                  <th style="width:110px">EXCLUIR</th>
                </tr>
              </thead>
              <tbody id="tbody-presenca"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="painel" id="painelEscalacao">
      <h2>Escalação do jogo</h2>
      <div class="status-info">OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) | <span style="color:#22c55e;font-weight:bold">P</span> (verde) pagou | <span style="color:#ef4444;font-weight:bold">P</span> (vermelho) não pagou</div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="clock-box" id="agora-2t">Hora agora: --:--</span>
        <button id="btn-escalar-2t" class="btn-primario">Escalar 2º tempo</button>
        <button id="btn-desfazer-2t" class="btn-neutro">Desfazer 2º tempo</button>
        <button id="btn-baixar-1t" class="btn-neutro">Baixar PDF 1º tempo</button>
        <button id="btn-baixar-2t" class="btn-neutro">Baixar PDF 2º tempo</button>
        <button id="btn-salvar" class="btn-secundario">Salvar</button>
      </div>

      <div class="grid-escalacao" style="margin-top:10px">
        <div class="col-escalacao">
          <div class="status-info" style="font-weight:bold">1º TEMPO</div>
          <table id="tbl-1t">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th>AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th>AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-1t"></tbody>
          </table>
        </div>

        <div class="col-escalacao">
          <div class="status-info" style="font-weight:bold">2º TEMPO</div>
          <table id="tbl-2t">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th>AMARELO</th>
                <th>AZUL</th>
              </tr>
            </thead>
            <tbody id="tbody-2t"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===== util ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function ymdToBr(s){
  if (!s) return "";
  const m = String(s).match(/(\d{4})-(\d{2})-(\d{2})/);
  return m ? `${m[3]}/${m[2]}/${m[1]}` : s;
}
function nextSunday(d){
  const x = new Date(d);
  const dow = x.getDay();
  const add = (7 - dow) % 7;
  x.setDate(x.getDate() + add);
  x.setHours(0,0,0,0);
  return x;
}

/* ===== API ===== */
const API = "/api/presenca_escalacao";

async function jget(url){
  const r = await fetch(url, { cache: "no-store" });
  const t = await r.text();
  let j;
  try { j = JSON.parse(t); } catch { j = { ok:false, error:`Resposta nao-JSON: ${t.slice(0,160)}` }; }
  if (!r.ok) throw new Error(j.error || `${r.status} ${r.statusText}`);
  if (!j.ok) throw new Error(j.error || "erro");
  return j;
}

async function jpost(url, body){
  const r = await fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body||{}) });
  const t = await r.text();
  let j;
  try { j = JSON.parse(t); } catch { j = { ok:false, error:`Resposta nao-JSON: ${t.slice(0,160)}` }; }
  if (!r.ok) throw new Error(j.error || `${r.status} ${r.statusText}`);
  if (!j.ok) throw new Error(j.error || "erro");
  return j;
}

/* ===== state ===== */
let STATE = null;

function nowLocalISO(){
  const d = new Date();
  const tz = -d.getTimezoneOffset();
  const sgn = tz >= 0 ? "+" : "-";
  const hh = pad2(Math.floor(Math.abs(tz)/60));
  const mm = pad2(Math.abs(tz)%60);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}${sgn}${hh}:${mm}`;
}

function setClock(){
  const d = new Date();
  const hhmm = `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
  const el1 = document.getElementById("agora-1t");
  const el2 = document.getElementById("agora-2t");
  if (el1) el1.textContent = `Hora agora: ${hhmm}`;
  if (el2) el2.textContent = `Hora agora: ${hhmm}`;
}

function setMsgOk(txt){
  const el = document.getElementById("msg");
  if (!el) return;
  el.innerHTML = `<span style="color:#22c55e;font-weight:bold">OK:</span> ${txt}`;
}

function setMsgErr(txt){
  const el = document.getElementById("msg");
  if (!el) return;
  el.innerHTML = `<span style="color:#ef4444;font-weight:bold">ERRO:</span> ${txt}`;
}

function getDataDomingo(){
  const el = document.getElementById("data_domingo");
  const s = (el && el.value ? el.value : "").trim();
  if (s) return s;
  return ymd(nextSunday(new Date()));
}

function idMapByApelido(){
  const m = new Map();
  const jogadores = (STATE && STATE.jogadores) ? STATE.jogadores : [];
  jogadores.forEach(j => m.set(String(j.apelido||""), j.id));
  return m;
}

function saiuMap(){
  const m = new Map();
  const pres = (STATE && (STATE.presencas || STATE.presenca)) ? (STATE.presencas || STATE.presenca) : [];
  pres.forEach(p => m.set(String(p.apelido||""), !!p.saiu));
  return m;
}

function chooseN(total){
  if (total >= 20) return 10;
  if (total >= 18) return 9;
  return 8;
}

async function loadAll(){
  try {
    setClock();
    const data_domingo = getDataDomingo();
    document.getElementById("data_domingo").value = data_domingo;
    document.getElementById("data_br").value = ymdToBr(data_domingo);

    const url = `${API}/state?data_domingo=${encodeURIComponent(data_domingo)}&now_local=${encodeURIComponent(nowLocalISO())}`;
    const j = await jget(url);
    STATE = j;

    const pres = (j.presencas || j.presenca || []);
    document.getElementById("presentesCount").textContent = `Presentes hoje: ${pres.length}`;

    renderJogadores();
    renderPresencas();
    renderEscalacao("1T");
    renderEscalacao("2T");

    setMsgOk(`lista carregada. (Domingo: ${data_domingo})`);
  } catch(e){
    setMsgErr(String(e.message || e));
  }
}

function renderJogadores(){
  const tbody = document.getElementById("tbodyJogadores");
  tbody.innerHTML = "";
  const jogadores = (STATE && STATE.jogadores) ? STATE.jogadores : [];

  jogadores.forEach(j => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="width:60px">${j.id||""}</td>
      <td>${j.apelido||""}</td>
      <td style="width:140px"><button class="btn-primario" data-id="${j.id}">CHEGOU AGORA</button></td>
    `;
    tr.querySelector("button").addEventListener("click", async () => {
      try {
        const data_domingo = getDataDomingo();
        await jpost(`${API}/chegou`, { id: j.id, data_domingo, now_local: nowLocalISO() });
        await loadAll();
      } catch(e){ setMsgErr(String(e.message||e)); }
    });
    tbody.appendChild(tr);
  });

  document.getElementById("totalJogadores").textContent = `TOTAL DE JOGADORES: ${jogadores.length}`;
}

function renderPresencas(){
  const tbody = document.getElementById("tbodyPresenca");
  tbody.innerHTML = "";
  const pres = (STATE && (STATE.presencas || STATE.presenca)) ? (STATE.presencas || STATE.presenca) : [];

  pres.forEach(p => {
    const nao = !!p.nao_joga;
    const tr = document.createElement("tr");
    if (nao) tr.style.opacity = "0.75";
    tr.innerHTML = `
      <td style="width:60px">${p.id||""}</td>
      <td style="width:70px">${p.ordem||""}</td>
      <td>${p.apelido||""}</td>
      <td style="width:80px">${p.hora||""}</td>
      <td>${p.obs||""}</td>
      <td style="width:170px"><button class="btn-neutro" data-id="${p.id}">${nao ? "NÃO JOGA" : "NÃO VAI JOGAR"}</button></td>
      <td style="width:110px"><button class="btn-excluir" data-id="${p.id}">EXCLUIR</button></td>
    `;

    const btnNJ = tr.querySelectorAll("button")[0];
    const btnEX = tr.querySelectorAll("button")[1];

    btnNJ.addEventListener("click", async () => {
      try {
        const data_domingo = getDataDomingo();
        await jpost(`${API}/toggle_nao_joga`, { id: p.id, data_domingo });
        await loadAll();
      } catch(e){ setMsgErr(String(e.message||e)); }
    });

    btnEX.addEventListener("click", async () => {
      try {
        const data_domingo = getDataDomingo();
        await jpost(`${API}/remove`, { id: p.id, data_domingo });
        await loadAll();
      } catch(e){ setMsgErr(String(e.message||e)); }
    });

    tbody.appendChild(tr);
  });
}

function renderEscalacao(tempo){
  const tbody = document.getElementById(tempo === "1T" ? "tbody-1t" : "tbody-2t");
  tbody.innerHTML = "";

  const idMap = idMapByApelido();
  const saiu = saiuMap();

  const arr = tempo === "1T" ? (STATE?.escalacao1 || []) : (STATE?.escalacao2 || []);
  const amarelo = arr.filter(x => String(x.time||"").toUpperCase() === "AMARELO").sort((a,b)=>Number(a.pos||0)-Number(b.pos||0));
  const azul = arr.filter(x => String(x.time||"").toUpperCase() === "AZUL").sort((a,b)=>Number(a.pos||0)-Number(b.pos||0));

  const n = chooseN(amarelo.length + azul.length);

  for (let i=1; i<=n; i++){
    const a = amarelo[i-1];
    const b = azul[i-1];
    const aAp = a?.apelido || "";
    const bAp = b?.apelido || "";

    const tr = document.createElement("tr");

    if (tempo === "1T"){
      tr.innerHTML = `
        <td style="width:60px">${aAp ? (idMap.get(aAp) || "") : ""}</td>
        <td style="width:60px">${i}</td>
        <td style="color:#fbbf24;font-weight:700">${aAp}</td>
        <td style="width:70px">
          <button class="btn-saiu" ${aAp?"":"disabled"} data-apelido="${aAp}">${saiu.get(aAp)?"SAIU":"SAIU"}</button>
        </td>
        <td style="color:#60a5fa;font-weight:700">${bAp}</td>
        <td style="width:70px">
          <button class="btn-saiu" ${bAp?"":"disabled"} data-apelido="${bAp}">${saiu.get(bAp)?"SAIU":"SAIU"}</button>
        </td>
      `;

      tr.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", async () => {
          const ap = btn.getAttribute("data-apelido");
          if (!ap) return;
          try {
            const data_domingo = getDataDomingo();
            await jpost(`${API}/toggle_saiu`, { apelido: ap, data_domingo });
            await loadAll();
          } catch(e){ setMsgErr(String(e.message||e)); }
        });
      });
    } else {
      tr.innerHTML = `
        <td style="width:60px">${aAp ? (idMap.get(aAp) || "") : ""}</td>
        <td style="width:60px">${i}</td>
        <td style="color:#fbbf24;font-weight:700">${aAp}</td>
        <td style="color:#60a5fa;font-weight:700">${bAp}</td>
      `;
    }

    tbody.appendChild(tr);
  }
}

/* ===== eventos ===== */
document.getElementById("data_br").addEventListener("change", () => {
  const v = document.getElementById("data_br").value.trim();
  const m = v.match(/(\d{2})\/(\d{2})\/(\d{4})/);
  if (m) document.getElementById("data_domingo").value = `${m[3]}-${m[2]}-${m[1]}`;
});

document.getElementById("btn-limpar").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await jpost(`${API}/limpar`, { data_domingo });
    await loadAll();
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-escalar-1t").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await jpost(`${API}/escalar_1t`, { data_domingo, now_local: nowLocalISO() });
    await loadAll();
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-desfazer-1t").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await jpost(`${API}/desfazer_1t`, { data_domingo });
    await loadAll();
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-escalar-2t").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await jpost(`${API}/escalar_2t`, { data_domingo, now_local: nowLocalISO() });
    await loadAll();
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-desfazer-2t").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await jpost(`${API}/desfazer_2t`, { data_domingo });
    await loadAll();
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-salvar").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await jpost(`${API}/salvar`, { data_domingo });
    setMsgOk("salvo");
  } catch(e){ setMsgErr(String(e.message||e)); }
});

/* ===== PDF (arquivo real via API) ===== */
async function downloadPdf(title, headCols, bodyRows, filename){
  const data_domingo = getDataDomingo();
  const safeTitle = title.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const headHtml = headCols.map(c => `<th>${String(c||'')}</th>`).join('');
  const rowsHtml = bodyRows.map(r => `<tr>${r.map(c => `<td>${String(c??'')}</td>`).join('')}</tr>`).join('');
  const html = `<!doctype html><html><head><meta charset="utf-8" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:24px;}
    h1{font-size:18px;margin:0 0 12px 0;}
    .meta{font-size:12px;margin:0 0 10px 0;}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid #333;padding:6px;font-size:11px;}
    th{background:#f7931a;color:#000;}
    .clock-mini{margin:6px 0 4px 0;font-size:12px;color:#fff;opacity:0.9;}
</style></head><body>
  <h1>${safeTitle}</h1>
  <div class="meta">Domingo: ${ymdToBr(data_domingo)}</div>
  <table><thead><tr>${headHtml}</tr></thead><tbody>${rowsHtml}</tbody></table>
  </body></html>`;

  const resp = await fetch('/api/pdf/render', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ html, filename })
  });
  if (!resp.ok) {
    const t = await resp.text().catch(()=>'');
    throw new Error(`PDF: HTTP ${resp.status} ${t}`);
  }
  const blob = await resp.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 5000);
}

document.getElementById("btn-baixar-presenca").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await downloadPdf(
      `PRESENÇA - ${ymdToBr(data_domingo)}`,
      ["ORDEM","APELIDO","HORA","OBS","NÃO VAI JOGAR"],
      buildPresencaRows(),
      `presenca_${data_domingo}.pdf`
    );
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-baixar-1t").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await downloadPdf(
      `ESCALAÇÃO 1º TEMPO - ${ymdToBr(data_domingo)}`,
      ["POS","AMARELO","AZUL"],
      buildEscalacaoRows("1T"),
      `escalacao_1T_${data_domingo}.pdf`
    );
  } catch(e){ setMsgErr(String(e.message||e)); }
});

document.getElementById("btn-baixar-2t").addEventListener("click", async () => {
  try {
    const data_domingo = getDataDomingo();
    await downloadPdf(
      `ESCALAÇÃO 2º TEMPO - ${ymdToBr(data_domingo)}`,
      ["POS","AMARELO","AZUL"],
      buildEscalacaoRows("2T"),
      `escalacao_2T_${data_domingo}.pdf`
    );
  } catch(e){ setMsgErr(String(e.message||e)); }
});

setInterval(setClock, 1000);
loadAll();
</script>

</body>
</html>
