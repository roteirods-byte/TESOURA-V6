<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
    .linhas-topo{display:flex;gap:16px;margin-bottom:16px}
    .col-50{flex:1;min-width:0}
    button{
      padding:6px 10px;border-radius:6px;border:none;cursor:pointer;
      font-weight:bold;text-transform:uppercase;font-size:11px;line-height:1;height:30px;min-width:110px
    }
    .btn-primario{background:#22c55e;color:#022c22}
    .btn-secundario{background:#0ea5e9;color:#0f172a}
    .btn-perigo{background:#ef4444;color:#f9fafb}
    .btn-neutro{background:#f97316;color:#0f172a}
    .btn-chegou{background:#10b981;color:#022c22;min-width:120px}
    .btn-nao-joga{background:#64748b;color:#e5e7eb;min-width:140px}
    .btn-excluir{background:#ef4444;color:#f9fafb;min-width:90px}
    .btn-sair{background:#f97316;color:#0f172a;min-width:70px;height:34px;border-radius:6px;font-size:11px}

    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
    th{background:#111827;color:#f97316;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .status-info{font-size:12px;margin-top:6px;color:#cbd5e1}
    .painel-scroll{overflow-y:auto;max-height:320px}
    .riscado{text-decoration:line-through;opacity:.55}
    .clock-box{font-size:12px;color:#cbd5e1;padding:6px 10px;border:1px solid rgba(148,163,184,0.25);border-radius:10px;background:rgba(15,23,42,0.35);display:inline-block}

    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
    .grid-escalacao table{table-layout:fixed;}
    .grid-escalacao th,.grid-escalacao td{overflow:hidden;text-overflow:ellipsis;}
  </style>

  <!-- PDF REAL (tabela, não print) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <header>TESOURA - PRESENÇA / ESCALAÇÃO</header>
  <div class="container">

    <div class="linhas-topo">
      <div class="col-50">
        <div class="painel">
          <h2>Jogadores (todos)</h2>
          <div class="status-info">Clique em <b>CHEGOU AGORA</b> quando o jogador chegar.</div>
          <div id="status-jogadores" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th>APELIDO</th>
                  <th style="width:170px">CHEGOU AGORA</th>
                </tr>
              </thead>
              <tbody id="tbody-jogadores-todos"></tbody>
            </table>
          </div>
          <div class="status-info" id="total-jogadores"></div>
        </div>
      </div>

      <div class="col-50">
        <div class="painel painel-presenca">
          <h2>Presença hoje</h2>

          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div class="status-info" id="status-presenca">Carregando...</div>
            <div>
              <span class="clock-box" id="data-jogo-box">Data do jogo: --/--/----</span>
              <span class="clock-box" style="margin-left:8px" id="hora-escalacao-box">Horário da escalação: 06:20</span>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button id="btn-limpar-hoje" class="btn-perigo">Limpar hoje</button>
            <button id="btn-escalar-1t" class="btn-primario">Escalar 1º tempo</button>

            <!-- marcador pedido: acima do desfazer 1T -->
            <div style="display:flex;flex-direction:column;gap:6px">
              <div class="clock-box" id="agora-1t">Hora agora: --:--</div>
              <button id="btn-desfazer-1t" class="btn-neutro">Desfazer 1º tempo</button>
            </div>

            <button id="btn-baixar-presenca" class="btn-neutro">Baixar PDF</button>
          </div>

          <div class="painel-scroll" style="margin-top:10px">
            <table id="tbl-presenca">
              <thead>
                <tr>
                  <th style="width:60px">ID</th>
                  <th style="width:70px">ORDEM</th>
                  <th>APELIDO</th>
                  <th style="width:90px">HORA</th>
                  <th style="width:110px">OBS</th>
                  <th style="width:160px">NÃO VAI JOGAR</th>
                  <th style="width:110px">EXCLUIR</th>
                </tr>
              </thead>
              <tbody id="tbody-presenca"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="painel" id="painelEscalacao">
      <h2>Escalação do jogo</h2>
      <div class="status-info">OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) | <span style="color:#22c55e;font-weight:bold">P</span> (verde) pagou | <span style="color:#ef4444;font-weight:bold">P</span> (vermelho) não pagou</div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="clock-box" id="agora-2t">Hora agora: --:--</span>
        <button id="btn-escalar-2t" class="btn-primario">Escalar 2º tempo</button>
        <button id="btn-desfazer-2t" class="btn-neutro">Desfazer 2º tempo</button>
        <button id="btn-baixar-1t" class="btn-neutro">Baixar PDF 1º tempo</button>
        <button id="btn-baixar-2t" class="btn-neutro">Baixar PDF 2º tempo</button>
        <button id="btn-salvar" class="btn-secundario">Salvar</button>
      </div>

      <div class="grid-escalacao" style="margin-top:10px">
        <div class="col-escalacao">
          <div class="status-info" style="font-weight:bold">1º TEMPO</div>
          <table id="tbl-1t">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th>AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th>AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-1t"></tbody>
          </table>
        </div>

        <div class="col-escalacao">
          <div class="status-info" style="font-weight:bold">2º TEMPO</div>
          <table id="tbl-2t">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th>AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th>AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-2t"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
/* ===== util ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function ymdToBr(s){
  s = String(s||"").trim();
  if(!s) return "";
  if(s.includes("/")) return s;
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m) return `${m[3]}/${m[2]}/${m[1]}`;
  return s;
}
function nowHHMM(){
  const d = new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function proximoDomingoISO(){
  const d = new Date();
  const add = (7 - d.getDay()) % 7;
  d.setDate(d.getDate() + add);
  return ymd(d);
}
async function fetchJSON(url, opt){
  const r = await fetch(url, opt || {});
  const txt = await r.text();
  let j = null;
  try { j = JSON.parse(txt); } catch(e) {}
  return { ok: r.ok, status: r.status, json: j, text: txt };
}
function alertApiErro(titulo, res){
  const head = (res && res.text) ? res.text.slice(0,120) : "";
  alert(`${titulo}\nHTTP ${res.status}\n${head}`);
}

/* ===== relógios ===== */
setInterval(() => {
  const hhmm = nowHHMM();
  const a1 = document.getElementById("agora-1t");
  const a2 = document.getElementById("agora-2t");
  if(a1) a1.textContent = `Hora agora: ${hhmm}`;
  if(a2) a2.textContent = `Hora agora: ${hhmm}`;
}, 500);

/* ===== estado ===== */
let STATE = null;

/* ===== carregar jogadores ===== */
async function carregarJogadores(){
  const status = document.getElementById("status-jogadores");
  const tbody = document.getElementById("tbody-jogadores-todos");
  const total = document.getElementById("total-jogadores");

  status.textContent = "Carregando jogadores...";
  tbody.innerHTML = "";

  const res = await fetchJSON("/api/jogadores");
  if(!res.ok || !res.json){
    status.textContent = "ERRO: /api/jogadores não retornou JSON.";
    return;
  }

  const itens = res.json.items || res.json.jogadores || res.json.data || [];
  itens.forEach(j => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${j.id ?? ""}</td>
      <td style="text-align:left;padding-left:8px">${(j.apelido ?? "").toString().toUpperCase()}</td>
      <td><button class="btn-chegou" data-id="${j.id}">CHEGOU AGORA</button></td>
    `;
    tbody.appendChild(tr);
  });

  total.textContent = `TOTAL DE JOGADORES: ${itens.length}`;

  tbody.querySelectorAll("button[data-id]").forEach(btn => {
    btn.onclick = async () => {
      const id = btn.getAttribute("data-id");
      const data_domingo = proximoDomingoISO();
      const body = { id: Number(id), data_domingo, hora: nowHHMM() };
      const r = await fetchJSON("/api/presenca_escalacao/chegou", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok || !r.json || r.json.ok !== true){
        alertApiErro("Erro ao marcar CHEGOU.", r);
        return;
      }
      await carregarState();
    };
  });

  status.textContent = "Base carregada.";
}

/* ===== carregar presença (state) ===== */
async function carregarState(){
  const status = document.getElementById("status-presenca");
  const data_domingo = proximoDomingoISO();
  document.getElementById("data-jogo-box").textContent = `Data do jogo: ${ymdToBr(data_domingo)}`;

  status.textContent = "Carregando...";
  const url = `/api/presenca_escalacao/state?data_domingo=${encodeURIComponent(data_domingo)}&now_local=${encodeURIComponent(ymd(new Date())+" "+nowHHMM())}`;
  const res = await fetchJSON(url);
  if(!res.ok || !res.json || res.json.ok !== true){
    status.textContent = "ERRO: state não retornou JSON ok.";
    return;
  }

  STATE = res.json;

  // render presença
  const tbody = document.getElementById("tbody-presenca");
  tbody.innerHTML = "";
  const lista = (STATE.presenca || STATE.data?.presenca || STATE.jogadores_presenca || []);
  status.textContent = `Presentes hoje: ${lista.length} (Domingo: ${data_domingo})`;

  lista.forEach((p, idx) => {
    const naoVai = !!(p.nao_vai_jogar || p.naoVaiJogar || p.nao_joga);
    const tr = document.createElement("tr");
    if(naoVai) tr.classList.add("riscado");
    tr.innerHTML = `
      <td>${p.id ?? ""}</td>
      <td>${p.ordem ?? (idx+1)}</td>
      <td style="text-align:left;padding-left:8px">${(p.apelido ?? "").toString().toUpperCase()}</td>
      <td>${p.hora ?? ""}</td>
      <td>${p.obs ?? ""}</td>
      <td><button class="btn-nao-joga" data-id="${p.id}">${naoVai ? "NÃO VAI JOGAR" : "NÃO VAI JOGAR"}</button></td>
      <td><button class="btn-excluir" data-id="${p.id}">EXCLUIR</button></td>
    `;
    tbody.appendChild(tr);
  });

  // bind NÃO VAI JOGAR
  tbody.querySelectorAll(".btn-nao-joga").forEach(btn => {
    btn.onclick = async () => {
      const id = Number(btn.getAttribute("data-id"));
      const data_domingo = proximoDomingoISO();

      const r = await fetchJSON("/api/presenca_escalacao/toggle_nao_joga", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id, data_domingo })
      });

      if(!r.ok || !r.json || r.json.ok !== true){
        alertApiErro("Erro ao alterar NÃO VAI JOGAR.", r);
        return;
      }
      await carregarState();
    };
  });

  // bind EXCLUIR
  tbody.querySelectorAll(".btn-excluir").forEach(btn => {
    btn.onclick = async () => {
      const id = Number(btn.getAttribute("data-id"));
      const data_domingo = proximoDomingoISO();

      const r = await fetchJSON("/api/presenca_escalacao/remove", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ id, data_domingo })
      });

      if(!r.ok || !r.json || r.json.ok !== true){
        alertApiErro("Erro ao excluir.", r);
        return;
      }
      await carregarState();
    };
  });
}

/* ===== PDF REAL PRESENÇA (jsPDF autoTable) ===== */
function pdfFileName(prefix){
  const d = ymdToBr(proximoDomingoISO()).replaceAll("/","-");
  return `${prefix}_${d}.pdf`;
}
function baixarPDFPresencaReal(){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("PDF: biblioteca não carregou (jsPDF).");
    return;
  }
  const doc = new window.jspdf.jsPDF({ orientation:"p", unit:"pt", format:"a4" });

  const data_domingo = proximoDomingoISO();
  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text(`PRESENÇA - DOMINGO ${ymdToBr(data_domingo)}`, 40, 40);

  const lista = (STATE && (STATE.presenca || STATE.data?.presenca || [])) || [];
  const rows = lista.map((p, i) => ([
    String(p.id ?? ""),
    String(p.ordem ?? (i+1)),
    String((p.apelido ?? "")).toUpperCase(),
    String(p.hora ?? ""),
    String(p.obs ?? ""),
    (p.nao_vai_jogar || p.naoVaiJogar || p.nao_joga) ? "SIM" : ""
  ]));

  doc.autoTable({
    startY: 60,
    head: [["ID","ORDEM","APELIDO","HORA","OBS","NÃO VAI JOGAR"]],
    body: rows,
    styles: { fontSize: 8, cellPadding: 3 },
    headStyles: { fillColor: [240,240,240], textColor: [0,0,0] }
  });

  doc.save(pdfFileName("TESOURA-PRESENCA"));
}

/* ===== botões topo ===== */
document.getElementById("btn-baixar-presenca").onclick = baixarPDFPresencaReal;

document.getElementById("btn-escalar-1t").onclick = async () => {
  const data_domingo = proximoDomingoISO();
  const r = await fetchJSON("/api/presenca_escalacao/escalar_1t", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data_domingo })
  });
  if(!r.ok || !r.json || r.json.ok !== true){
    alertApiErro("Erro ao escalar 1º tempo.", r);
    return;
  }
  await carregarState();
};

document.getElementById("btn-desfazer-1t").onclick = async () => {
  const data_domingo = proximoDomingoISO();
  const r = await fetchJSON("/api/presenca_escalacao/desfazer_1t", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data_domingo })
  });
  if(!r.ok || !r.json || r.json.ok !== true){
    alertApiErro("Erro ao desfazer 1º tempo.", r);
    return;
  }
  await carregarState();
};

document.getElementById("btn-limpar-hoje").onclick = async () => {
  const data_domingo = proximoDomingoISO();
  const r = await fetchJSON("/api/presenca_escalacao/limpar", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data_domingo })
  });
  if(!r.ok || !r.json || r.json.ok !== true){
    alertApiErro("Erro ao limpar hoje.", r);
    return;
  }
  await carregarState();
};

/* ===== init ===== */
(async () => {
  await carregarJogadores();
  await carregarState();
})();
</script>

</body>
</html>
