<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- REVISAO_PRESENCA_R1 - 2026-01-24
    - Corrige: NÃO VAI JOGAR / EXCLUIR / ESCALAR 1T
    - PDF Presença = arquivo (jsPDF + autoTable) (não print)
    - PDF Escalação 1T/2T = print (html2pdf) (como você aceitou)
    - Evita erros de console: não faz .json() em HTML/404
    - Tenta múltiplos endpoints (fallback) e usa o primeiro que funcionar
  -->

  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
    .linhas-topo{display:flex;gap:16px;margin-bottom:16px}
    .col-50{flex:1;min-width:0}

    .row-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{font-size:12px;color:#cbd5e1;padding:6px 10px;border:1px solid rgba(148,163,184,0.25);border-radius:10px;background:rgba(15,23,42,0.35);display:inline-block}
    .badge strong{color:#f9fafb}
    .spacer{flex:1}

    button{
      padding:6px 10px;
      border-radius:6px;
      border:none;
      cursor:pointer;
      font-weight:bold;
      text-transform:uppercase;
      font-size:11px;
      line-height:1;
      height:30px;
      min-width:110px;
    }
    .btn-primario{background:#22c55e;color:#022c22}
    .btn-secundario{background:#0ea5e9;color:#0f172a}
    .btn-perigo{background:#ef4444;color:#f9fafb}
    .btn-neutro{background:#f97316;color:#0f172a}
    .btn-chegou{background:#10b981;color:#022c22;min-width:120px}
    .btn-nao-joga{background:#64748b;color:#e5e7eb;min-width:140px}
    .btn-excluir{background:#ef4444;color:#f9fafb;min-width:90px}
    .btn-saiu{min-width:56px;height:24px;font-size:10px;padding:0 8px;line-height:1;background:#22c55e;color:#0b1220;border:1px solid rgba(34,197,94,0.6);border-radius:8px;cursor:pointer;}
    .btn-saiu:hover{filter:brightness(1.05);}

    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
    th{background:#111827;color:#f97316;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}

    .status-info{font-size:12px;margin-top:6px;color:#cbd5e1}
    .painel-scroll{overflow-y:auto;max-height:320px}
    .linhas-topo .col-50:first-child .painel-scroll{max-height:420px;}

    .riscado{text-decoration:line-through;opacity:.55}
    .muted{color:#cbd5e1;opacity:.9}

    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
    .grid-escalacao table{table-layout:fixed;}
    .grid-escalacao th,.grid-escalacao td{overflow:hidden;text-overflow:ellipsis;}

    .totais{font-weight:bold;text-align:right;margin-top:6px;font-size:12px;color:#cbd5e1}
    .legenda{font-size:11px;margin-top:10px;color:#cbd5e1}
    .t-amarelo{color:#facc15;font-weight:bold}
    .t-azul{color:#38bdf8;font-weight:bold}

    .input-data{
      height:30px;border-radius:10px;border:1px solid rgba(148,163,184,0.25);
      padding:0 10px;background:rgba(15,23,42,0.35);color:#f9fafb;
      font-weight:bold;
    }

    /* “pdf-print” (somente para escalações 1T/2T via html2pdf) */
    body.pdf-mode button, body.pdf-mode .no-print{ display:none !important; }
    body.pdf-1t .linhas-topo{ display:none !important; }
    body.pdf-1t .grid-escalacao .col-escalacao:nth-child(2){ display:none !important; }
    body.pdf-1t .grid-escalacao{ grid-template-columns:1fr !important; }
    body.pdf-2t .linhas-topo{ display:none !important; }
    body.pdf-2t .grid-escalacao .col-escalacao:nth-child(1){ display:none !important; }
    body.pdf-2t .grid-escalacao{ grid-template-columns:1fr !important; }
  </style>

  <!-- libs:
    - jsPDF + autoTable: PDF "arquivo" (texto) da presença
    - html2pdf: print (ok) das escalações
  -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</head>

<body>
  <header>TESOURA - PRESENÇA / ESCALAÇÃO</header>

  <div class="container">

    <div class="linhas-topo">

      <!-- COLUNA 1: JOGADORES -->
      <div class="col-50">
        <div class="painel">
          <h2>Jogadores (todos)</h2>
          <div class="status-info">Clique em <b>CHEGOU AGORA</b> quando o jogador chegar.</div>
          <div id="status-jogadores" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th>APELIDO</th>
                  <th style="width:170px">CHEGOU AGORA</th>
                </tr>
              </thead>
              <tbody id="tbody-jogadores-todos"></tbody>
            </table>
          </div>

          <div class="totais" id="total-jogadores"></div>
        </div>
      </div>

      <!-- COLUNA 2: PRESENÇA HOJE -->
      <div class="col-50">
        <div class="painel painel-presenca">
          <h2>Presença hoje</h2>

          <div class="row-actions" style="margin-bottom:8px">
            <div class="muted">Presentes hoje: <b id="qtd-presenca">0</b></div>
            <div class="spacer"></div>
            <div class="muted">Data do jogo:</div>
            <input id="data-jogo" class="input-data" type="date" />
            <span class="badge"><strong>Horário da escalação:</strong> 06:20</span>
          </div>

          <div class="row-actions" style="margin-bottom:8px">
            <button id="btn-limpar-hoje" class="btn-perigo">Limpar hoje</button>
            <button id="btn-escalar-1t" class="btn-primario">Escalar 1º tempo</button>

            <div style="display:flex;flex-direction:column;gap:6px">
              <div class="badge" id="badge-hora-desfazer-1t">Hora agora: --:--</div>
              <button id="btn-desfazer-1t" class="btn-neutro">Desfazer 1º tempo</button>
            </div>

            <button id="btn-pdf-presenca" class="btn-neutro">Baixar PDF</button>

            <span id="status-presenca" class="status-info" style="margin:0"></span>
          </div>

          <div class="painel-scroll" style="max-height:360px">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th style="width:70px">ORDEM</th>
                  <th>APELIDO</th>
                  <th style="width:70px">HORA</th>
                  <th style="width:70px">OBS</th>
                  <th style="width:160px">NÃO VAI JOGAR</th>
                  <th style="width:120px">EXCLUIR</th>
                </tr>
              </thead>
              <tbody id="tbody-presenca-hoje"></tbody>
            </table>
          </div>

          <div class="legenda">
            Obs: nomes riscados = <b>NÃO VAI JOGAR</b> ou já escalados (não entram de novo).
          </div>
        </div>
      </div>

    </div>

    <!-- ESCALAÇÃO -->
    <div class="painel" id="painelEscalacao">
      <h2>Escalação do jogo</h2>

      <div class="row-actions" style="margin-bottom:8px">
        <span class="badge" id="badge-hora-agora">Hora agora: --:--</span>

        <button id="btn-escalar-2t" class="btn-primario">Escalar 2º tempo</button>
        <button id="btn-desfazer-2t" class="btn-neutro">Desfazer 2º tempo</button>

        <button id="btn-pdf-1t" class="btn-neutro">Baixar PDF 1º tempo</button>
        <button id="btn-pdf-2t" class="btn-neutro">Baixar PDF 2º tempo</button>

        <button id="btn-salvar" class="btn-secundario">Salvar</button>

        <span class="spacer"></span>
        <span class="muted" id="status-escalacao"></span>
      </div>

      <div class="grid-escalacao">
        <!-- 1T -->
        <div class="col-escalacao" id="col-1t">
          <div class="muted" style="font-weight:bold;margin-bottom:6px">
            1º TEMPO — JOGO DAS 06:40 ÀS 07:40
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th class="t-amarelo">AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th class="t-azul">AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-esc-1t"></tbody>
          </table>
          <div class="legenda" style="text-align:right">Botão <b>SAIU</b> risca o nome.</div>
        </div>

        <!-- 2T -->
        <div class="col-escalacao" id="col-2t">
          <div class="muted" style="font-weight:bold;margin-bottom:6px">
            2º TEMPO — JOGO DAS 08:00 ÀS 09:00
          </div>
          <table>
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th class="t-amarelo">AMARELO</th>
                <th style="width:70px">SAIU</th>
                <!-- AZUL na coluna CERTA -->
                <th class="t-azul">AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-esc-2t"></tbody>
          </table>
          <div class="legenda" style="text-align:right">Prioridade: quem não jogou.</div>
        </div>
      </div>

      <div class="legenda" style="margin-top:10px">
        OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) |
        <span style="color:#22c55e;font-weight:bold">P (verde) pagou</span> |
        <span style="color:#ef4444;font-weight:bold">P (vermelho) não pagou</span>
      </div>
    </div>

  </div>

<script>
(() => {
  // =======================
  // Helpers de data/hora
  // =======================
  const pad2 = n => String(n).padStart(2,"0");
  const ymd = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const hm  = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;

  function ymdToBr(s){
    s = String(s||"").trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m) return `${m[3]}/${m[2]}/${m[1]}`;
    return s;
  }

  // Próximo domingo (inclui hoje se já for domingo)
  function proximoDomingoISO(){
    const d = new Date();
    const dow = d.getDay(); // 0=domingo
    const add = (7 - dow) % 7;
    d.setDate(d.getDate() + add);
    return ymd(d);
  }

  function nowLocalStr(){
    const d = new Date();
    return `${ymd(d)} ${hm(d)}`;
  }

  // =======================
  // DOM refs
  // =======================
  const el = id => document.getElementById(id);

  const statusJog = el("status-jogadores");
  const statusPres = el("status-presenca");
  const statusEsc = el("status-escalacao");

  const tbodyJog = el("tbody-jogadores-todos");
  const tbodyPres = el("tbody-presenca-hoje");
  const tbody1 = el("tbody-esc-1t");
  const tbody2 = el("tbody-esc-2t");

  const totalJog = el("total-jogadores");
  const qtdPres = el("qtd-presenca");

  const dataJogo = el("data-jogo");

  // Clock badges
  const badgeHoraAgora = el("badge-hora-agora");
  const badgeHoraDesf = el("badge-hora-desfazer-1t");

  function tickClocks(){
    const d = new Date();
    const txt = `Hora agora: ${hm(d)}`;
    badgeHoraAgora.textContent = txt;
    badgeHoraDesf.textContent = txt;
  }
  tickClocks();
  setInterval(tickClocks, 15000);

  // default date
  dataJogo.value = proximoDomingoISO();

  // =======================
  // API (robusta contra 404/HTML)
  // =======================
  async function fetchSmart(url, opts){
    const r = await fetch(url, opts || {});
    const ct = (r.headers.get("content-type") || "").toLowerCase();
    const text = await r.text();

    // se veio HTML (404 do nginx etc.), não tenta JSON
    const looksHtml = text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html") || ct.includes("text/html");
    if(looksHtml){
      return { ok:false, http:r.status, html:true, text };
    }

    // tenta JSON
    let j = null;
    try { j = JSON.parse(text); } catch(e){
      return { ok:false, http:r.status, json:false, text };
    }

    if(!r.ok) return { ok:false, http:r.status, j };
    return { ok:true, http:r.status, j };
  }

  async function getFirstOk(urls){
    for(const u of urls){
      const res = await fetchSmart(u, { method:"GET" });
      if(res.ok && res.j && res.j.ok) return res.j;
    }
    return null;
  }

  async function postFirstOk(urls, body){
    for(const u of urls){
      const res = await fetchSmart(u, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body || {})
      });
      if(res.ok && res.j && res.j.ok) return res.j;
    }
    return null;
  }

  // =======================
  // Endpoints (tentativas)
  // =======================
  function q(v){ return encodeURIComponent(v); }

  function urlsState(){
    const d = dataJogo.value || proximoDomingoISO();
    const now = nowLocalStr();
    return [
      `/api/presenca_escalacao/state?data_domingo=${q(d)}&now_local=${q(now)}`,
      `/api/presenca_escalacao/state?data_domingo=${q(d)}`,
      `/api/presenca_escalacao/state`,
    ];
  }

  function urlsChegouAgora(){
    return [
      `/api/presenca_escalacao/chegou_agora`,
      `/api/presenca_escalacao/chegouAgora`,
      `/api/presenca_escalacao/chegou`,
      `/api/presenca_escalacao/add`,
      `/api/presenca_escalacao/presenca/add`,
    ];
  }

  function urlsToggleNaoJoga(){
    return [
      `/api/presenca_escalacao/toggle_nao_joga`,
      `/api/presenca_escalacao/toggle_nao_jogar`,
      `/api/presenca_escalacao/nao_joga/toggle`,
      `/api/presenca_escalacao/nao_vai_jogar/toggle`,
      `/api/presenca_escalacao/toggleNaoJoga`,
    ];
  }

  function urlsExcluir(){
    return [
      `/api/presenca_escalacao/remover`,
      `/api/presenca_escalacao/excluir`,
      `/api/presenca_escalacao/remove`,
      `/api/presenca_escalacao/presenca/remover`,
      `/api/presenca_escalacao/presenca/excluir`,
    ];
  }

  function urlsLimparHoje(){
    return [
      `/api/presenca_escalacao/limpar_hoje`,
      `/api/presenca_escalacao/limparHoje`,
      `/api/presenca_escalacao/reset`,
      `/api/presenca_escalacao/clear`,
    ];
  }

  function urlsEscalar1T(){
    return [
      `/api/presenca_escalacao/escalar_1t`,
      `/api/presenca_escalacao/escalar1t`,
      `/api/presenca_escalacao/escalar_1T`,
      `/api/presenca_escalacao/escalar_primeiro_tempo`,
    ];
  }

  function urlsDesfazer1T(){
    return [
      `/api/presenca_escalacao/desfazer_1t`,
      `/api/presenca_escalacao/desfazer1t`,
      `/api/presenca_escalacao/desfazer_1T`,
      `/api/presenca_escalacao/desfazer_primeiro_tempo`,
    ];
  }

  function urlsEscalar2T(){
    return [
      `/api/presenca_escalacao/escalar_2t`,
      `/api/presenca_escalacao/escalar2t`,
      `/api/presenca_escalacao/escalar_2T`,
      `/api/presenca_escalacao/escalar_segundo_tempo`,
    ];
  }

  function urlsDesfazer2T(){
    return [
      `/api/presenca_escalacao/desfazer_2t`,
      `/api/presenca_escalacao/desfazer2t`,
      `/api/presenca_escalacao/desfazer_2T`,
      `/api/presenca_escalacao/desfazer_segundo_tempo`,
    ];
  }

  function urlsSalvar(){
    return [
      `/api/presenca_escalacao/salvar`,
      `/api/presenca_escalacao/save`,
      `/api/presenca_escalacao/salvar_escalacao`,
    ];
  }

  function urlsSaiu(){
    return [
      `/api/presenca_escalacao/saiu`,
      `/api/presenca_escalacao/toggle_saiu`,
      `/api/presenca_escalacao/marcar_saiu`,
    ];
  }

  // =======================
  // Estado / render
  // =======================
  let STATE = null;

  function pick(obj, paths, fallback){
    for(const p of paths){
      const parts = p.split(".");
      let cur = obj;
      let ok = true;
      for(const k of parts){
        if(cur && Object.prototype.hasOwnProperty.call(cur, k)) cur = cur[k];
        else { ok=false; break; }
      }
      if(ok && cur != null) return cur;
    }
    return fallback;
  }

  function normArray(x){
    if(Array.isArray(x)) return x;
    if(x && Array.isArray(x.items)) return x.items;
    return [];
  }

  function getDataDomingo(){
    return dataJogo.value || proximoDomingoISO();
  }

  function presencaKeyNaoJoga(item){
    return !!(item?.nao_vai_jogar || item?.nao_joga || item?.naoVaiJogar || item?.naoJoga);
  }

  function safeUpper(s){ return String(s||"").toUpperCase(); }

  function render(){
    const st = STATE || {};
    const core = pick(st, ["data","state"], st);

    const jogadores = normArray(pick(core, ["jogadores","players","lista_jogadores"], []));
    const presenca  = normArray(pick(core, ["presenca","presencas","lista_presenca","hoje","presentes"], []));

    const esc1 = normArray(pick(core, ["escalacao1t","escalacao_1t","esc_1t","escalacao.1t","escalacao.um"], []));
    const esc2 = normArray(pick(core, ["escalacao2t","escalacao_2t","esc_2t","escalacao.2t","escalacao.dois"], []));

    // players
    tbodyJog.innerHTML = "";
    jogadores.forEach(j => {
      const tr = document.createElement("tr");

      const id = j.id ?? j.ID ?? "";
      const apelido = j.apelido ?? j.nome ?? j.NOME ?? "";

      tr.innerHTML = `
        <td>${id}</td>
        <td style="text-align:left;padding-left:8px">${safeUpper(apelido)}</td>
        <td><button class="btn-chegou" data-action="chegou" data-id="${id}">CHEGOU AGORA</button></td>
      `;
      tbodyJog.appendChild(tr);
    });
    totalJog.textContent = `TOTAL DE JOGADORES: ${jogadores.length}`;

    // presenca
    tbodyPres.innerHTML = "";
    qtdPres.textContent = presenca.length;

    presenca.forEach((p, idx) => {
      const tr = document.createElement("tr");

      const id = p.id ?? p.ID ?? "";
      const ordem = p.ordem ?? p.ORDEM ?? (idx+1);
      const apelido = p.apelido ?? p.nome ?? p.NOME ?? "";
      const hora = p.hora ?? p.HORA ?? "";
      const obs = p.obs ?? p.OBS ?? "";

      const isNaoJoga = presencaKeyNaoJoga(p);

      const apelidoCls = isNaoJoga ? "riscado" : "";
      const btnNaoJogaTxt = isNaoJoga ? "NÃO VAI JOGAR ✓" : "NÃO VAI JOGAR";

      tr.innerHTML = `
        <td>${id}</td>
        <td>${ordem}</td>
        <td class="${apelidoCls}" style="text-align:left;padding-left:8px">${safeUpper(apelido)}</td>
        <td>${safeUpper(hora)}</td>
        <td>${safeUpper(obs)}</td>
        <td>
          <button class="btn-nao-joga" data-action="naojoga" data-id="${id}">${btnNaoJogaTxt}</button>
        </td>
        <td>
          <button class="btn-excluir" data-action="excluir" data-id="${id}">EXCLUIR</button>
        </td>
      `;
      tbodyPres.appendChild(tr);
    });

    // escalacao 1t
    tbody1.innerHTML = "";
    const rows1 = esc1.length ? esc1 : Array.from({length:10}).map((_,i)=>({pos:i+1}));
    rows1.forEach((r, i) => {
      const pos = r.pos ?? r.POS ?? (i+1);
      const id = r.id ?? r.ID ?? "";
      const am = r.amarelo ?? r.AMARELO ?? r.time_amarelo ?? "";
      const az = r.azul ?? r.AZUL ?? r.time_azul ?? "";

      const saiuAm = !!(r.saiu_amarelo || r.SAIU_AMARELO || r.saiuAmarelo);
      const saiuAz = !!(r.saiu_azul || r.SAIU_AZUL || r.saiuAzul);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${id}</td>
        <td>${pos}</td>
        <td class="${saiuAm ? "riscado":""}" style="text-align:left;padding-left:8px">${safeUpper(am)}</td>
        <td><button class="btn-saiu" data-action="saiu" data-tempo="1t" data-lado="amarelo" data-pos="${pos}">SAIU</button></td>
        <td class="${saiuAz ? "riscado":""}" style="text-align:left;padding-left:8px">${safeUpper(az)}</td>
        <td><button class="btn-saiu" data-action="saiu" data-tempo="1t" data-lado="azul" data-pos="${pos}">SAIU</button></td>
      `;
      tbody1.appendChild(tr);
    });

    // escalacao 2t
    tbody2.innerHTML = "";
    const rows2 = esc2.length ? esc2 : Array.from({length:10}).map((_,i)=>({pos:i+1}));
    rows2.forEach((r, i) => {
      const pos = r.pos ?? r.POS ?? (i+1);
      const id = r.id ?? r.ID ?? "";
      const am = r.amarelo ?? r.AMARELO ?? r.time_amarelo ?? "";
      const az = r.azul ?? r.AZUL ?? r.time_azul ?? "";

      const saiuAm = !!(r.saiu_amarelo || r.SAIU_AMARELO || r.saiuAmarelo);
      const saiuAz = !!(r.saiu_azul || r.SAIU_AZUL || r.saiuAzul);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${id}</td>
        <td>${pos}</td>
        <td class="${saiuAm ? "riscado":""}" style="text-align:left;padding-left:8px">${safeUpper(am)}</td>
        <td><button class="btn-saiu" data-action="saiu" data-tempo="2t" data-lado="amarelo" data-pos="${pos}">SAIU</button></td>
        <td class="${saiuAz ? "riscado":""}" style="text-align:left;padding-left:8px">${safeUpper(az)}</td>
        <td><button class="btn-saiu" data-action="saiu" data-tempo="2t" data-lado="azul" data-pos="${pos}">SAIU</button></td>
      `;
      tbody2.appendChild(tr);
    });
  }

  async function loadState(){
    statusJog.textContent = "Carregando...";
    statusPres.textContent = "Carregando...";
    statusEsc.textContent = "Carregando...";

    const j = await getFirstOk(urlsState());
    if(!j){
      const d = getDataDomingo();
      statusJog.textContent = "ERRO: /state não respondeu (ver backend).";
      statusPres.textContent = `ERRO ao carregar (domingo: ${ymdToBr(d)}).`;
      statusEsc.textContent = "";
      return;
    }

    STATE = j;
    statusJog.textContent = "Base carregada.";
    statusPres.textContent = `Lista carregada. (Domingo: ${getDataDomingo()})`;
    statusEsc.textContent = "";
    render();
  }

  // =======================
  // Ações
  // =======================
  async function actionChegou(id){
    const body = { id, data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsChegouAgora(), body);
    if(!ok) alert("Erro ao marcar CHEGOU AGORA.");
    await loadState();
  }

  async function actionNaoJoga(id){
    const body = { id, data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsToggleNaoJoga(), body);
    if(!ok) alert("Erro ao alterar NÃO VAI JOGAR.");
    await loadState();
  }

  async function actionExcluir(id){
    const body = { id, data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsExcluir(), body);
    if(!ok) alert("Erro ao excluir.");
    await loadState();
  }

  async function actionLimparHoje(){
    if(!confirm("Tem certeza que deseja LIMPAR HOJE?")) return;
    const body = { data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsLimparHoje(), body);
    if(!ok) alert("Erro ao limpar hoje.");
    await loadState();
  }

  async function actionEscalar1T(){
    const body = { data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsEscalar1T(), body);
    if(!ok) alert("Erro ao escalar 1º tempo.");
    await loadState();
  }

  async function actionDesfazer1T(){
    if(!confirm("Desfazer 1º tempo?")) return;
    const body = { data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsDesfazer1T(), body);
    if(!ok) alert("Erro ao desfazer 1º tempo.");
    await loadState();
  }

  async function actionEscalar2T(){
    const body = { data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsEscalar2T(), body);
    if(!ok) alert("Erro ao escalar 2º tempo.");
    await loadState();
  }

  async function actionDesfazer2T(){
    if(!confirm("Desfazer 2º tempo?")) return;
    const body = { data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsDesfazer2T(), body);
    if(!ok) alert("Erro ao desfazer 2º tempo.");
    await loadState();
  }

  async function actionSalvar(){
    const body = { data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsSalvar(), body);
    if(!ok) alert("Erro ao salvar.");
    await loadState();
  }

  async function actionSaiu(tempo, lado, pos){
    const body = { tempo, lado, pos:Number(pos), data_domingo:getDataDomingo(), now_local:nowLocalStr() };
    const ok = await postFirstOk(urlsSaiu(), body);
    if(!ok) alert("Erro ao marcar SAIU.");
    await loadState();
  }

  // =======================
  // PDF (PRESENÇA = arquivo texto, não print)
  // =======================
  function pdfFileName(prefix){
    const d = getDataDomingo(); // yyyy-mm-dd
    const br = ymdToBr(d).replaceAll("/","-");
    return `${prefix}_${br}.pdf`;
  }

  function getPresencaRowsForPdf(){
    const st = STATE || {};
    const core = pick(st, ["data","state"], st);
    const presenca  = normArray(pick(core, ["presenca","presencas","lista_presenca","hoje","presentes"], []));
    return presenca.map((p, idx) => {
      const id = p.id ?? p.ID ?? "";
      const ordem = p.ordem ?? p.ORDEM ?? (idx+1);
      const apelido = (p.apelido ?? p.nome ?? p.NOME ?? "").toString().toUpperCase();
      const hora = (p.hora ?? p.HORA ?? "").toString().toUpperCase();
      const obs = (p.obs ?? p.OBS ?? "").toString().toUpperCase();
      const nao = presencaKeyNaoJoga(p) ? "SIM" : "";
      return [String(id), String(ordem), apelido, hora, obs, nao];
    });
  }

  function baixarPdfPresencaArquivo(){
    // jsPDF UMD fica em window.jspdf.jsPDF :contentReference[oaicite:0]{index=0}
    if(!window.jspdf || !window.jspdf.jsPDF){
      alert("PDF: jsPDF não carregou.");
      return;
    }
    const doc = new window.jspdf.jsPDF({orientation:"landscape", unit:"pt", format:"a4"});
    const title = `PRESENÇA - DOMINGO ${ymdToBr(getDataDomingo())}`;
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text(title, 40, 34);

    const rows = getPresencaRowsForPdf();

    // autoTable plugin adiciona doc.autoTable() :contentReference[oaicite:1]{index=1}
    if(typeof doc.autoTable !== "function"){
      alert("PDF: autoTable não carregou.");
      return;
    }

    doc.setFont("helvetica","normal");
    doc.setFontSize(10);

    doc.autoTable({
      startY: 50,
      head: [["ID","ORDEM","APELIDO","HORA","OBS","NÃO VAI JOGAR"]],
      body: rows,
      styles: { font: "helvetica", fontSize: 9, cellPadding: 3 },
      headStyles: { fillColor: [249,115,22], textColor: [15,23,42] },
      alternateRowStyles: { fillColor: [11,17,32] },
      theme: "grid",
      margin: { left: 40, right: 40 }
    });

    doc.save(pdfFileName("TESOURA-PRESENCA"));
  }

  // =======================
  // PDF (ESCALAÇÃO 1T/2T = print ok)
  // =======================
  async function baixarPdfEscalacao(tipo){
    if(typeof html2pdf === "undefined"){
      alert("PDF: html2pdf não carregou.");
      return;
    }

    document.body.classList.add("pdf-mode");
    document.body.classList.remove("pdf-1t","pdf-2t");
    if(tipo === "1t") document.body.classList.add("pdf-1t");
    if(tipo === "2t") document.body.classList.add("pdf-2t");

    // espera layout “assentar”
    await new Promise(r => setTimeout(r, 50));

    try{
      const opt = {
        margin: 8,
        filename: pdfFileName(tipo === "1t" ? "TESOURA-ESCALACAO-1T" : "TESOURA-ESCALACAO-2T"),
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
      };
      await html2pdf().set(opt).from(document.body).save();
    } catch(e){
      alert("ERRO PDF: " + (e && (e.message||e) ? (e.message||e) : "falha"));
    } finally{
      document.body.classList.remove("pdf-mode","pdf-1t","pdf-2t");
    }
  }

  // =======================
  // Eventos (delegação)
  // =======================
  document.addEventListener("click", async (ev) => {
    const btn = ev.target.closest("button");
    if(!btn) return;

    const action = btn.getAttribute("data-action");
    if(!action) return;

    const id = btn.getAttribute("data-id");

    try{
      if(action === "chegou") return await actionChegou(id);
      if(action === "naojoga") return await actionNaoJoga(id);
      if(action === "excluir") return await actionExcluir(id);
      if(action === "saiu") return await actionSaiu(btn.getAttribute("data-tempo"), btn.getAttribute("data-lado"), btn.getAttribute("data-pos"));
    } catch(e){
      console.error(e);
      alert("Erro na ação. Veja o console.");
    }
  });

  el("btn-limpar-hoje").onclick = actionLimparHoje;
  el("btn-escalar-1t").onclick = actionEscalar1T;
  el("btn-desfazer-1t").onclick = actionDesfazer1T;

  el("btn-escalar-2t").onclick = actionEscalar2T;
  el("btn-desfazer-2t").onclick = actionDesfazer2T;

  el("btn-salvar").onclick = actionSalvar;

  el("btn-pdf-presenca").onclick = baixarPdfPresencaArquivo;
  el("btn-pdf-1t").onclick = () => baixarPdfEscalacao("1t");
  el("btn-pdf-2t").onclick = () => baixarPdfEscalacao("2t");

  // mudar data recarrega
  dataJogo.addEventListener("change", () => loadState());

  // init
  loadState();
})();
</script>

</body>
</html>
