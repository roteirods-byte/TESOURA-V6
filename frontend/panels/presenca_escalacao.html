<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px;font-size:12px}
    .linhas-topo{display:flex;gap:16px;margin-bottom:16px}
    .col-50{flex:1;min-width:0}
    button{
      padding:6px 10px;border-radius:6px;border:none;cursor:pointer;
      font-weight:bold;text-transform:uppercase;font-size:11px;line-height:1;height:30px;min-width:110px
    }
    .btn-primario{background:#22c55e;color:#022c22}
    .btn-secundario{background:#0ea5e9;color:#0f172a}
    .btn-perigo{background:#ef4444;color:#f9fafb}
    .btn-neutro{background:#f97316;color:#0f172a}
    .btn-chegou{background:#10b981;color:#022c22;min-width:120px}
    .btn-nao-joga{background:#64748b;color:#e5e7eb;min-width:140px}
    .btn-excluir{background:#ef4444;color:#f9fafb;min-width:90px}
    .btn-sair{background:#f97316;color:#0f172a;min-width:70px;height:34px;border-radius:6px;font-size:11px}

    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
    th{background:#111827;color:#f97316;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .status-info{font-size:12px;margin-top:6px;color:#cbd5e1}
    .painel-scroll{overflow-y:auto;max-height:320px}
    .riscado{text-decoration:line-through;opacity:.55}
    .clock-box{font-size:12px;color:#cbd5e1;padding:6px 10px;border:1px solid rgba(148,163,184,0.25);border-radius:10px;background:rgba(15,23,42,0.35);display:inline-block}

    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){.grid-escalacao{grid-template-columns:1fr}}
    .grid-escalacao table{table-layout:fixed;}
    .grid-escalacao th,.grid-escalacao td{overflow:hidden;text-overflow:ellipsis;}
    .clock-mini{margin:6px 0 4px 0;font-size:12px;color:#fff;opacity:0.9;}

.info-mini{margin:6px 0 8px 0;color:#e5e7eb;font-size:13px;}
</style>

  <!-- PDF REAL (arquivo, não print) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
<script>
  // Helpers (defensivos)
  async function apiGetJson(url) {
    const resp = await fetch(url, { cache: "no-store" });
    const text = await resp.text();
    let data = null;
    try { data = JSON.parse(text); } catch (_) {}
    if (!resp.ok) {
      const msg = data?.error ? String(data.error) : (text || `HTTP ${resp.status}`);
      throw new Error(msg);
    }
    return data;
  }
  function byId(id){ return document.getElementById(id); }
  function ymdToBr(ymd){
    if(!ymd) return "";
    const m = String(ymd).match(/(\d{4})[-\/](\d{2})[-\/](\d{2})/);
    if(!m) return String(ymd);
    return `${m[3]}/${m[2]}/${m[1]}`;
  }
  function calcIdade(ymd){
    const m = String(ymd||"").match(/(\d{4})-(\d{2})-(\d{2})/);
    if(!m) return "";
    const y=+m[1], mo=+m[2]-1, d=+m[3];
    const dob=new Date(y,mo,d);
    const now=new Date();
    let age = now.getFullYear()-dob.getFullYear();
    const md = now.getMonth()-dob.getMonth();
    if(md<0 || (md===0 && now.getDate()<dob.getDate())) age--;
    return String(age);
  }
</script>
</head>

<body>
  <header>TESOURA - PRESENÇA / ESCALAÇÃO</header>
  <div class="container">

    <div class="linhas-topo">
      <div class="col-50">
        <div class="painel">
          <h2>Jogadores (todos)</h2>
          <div class="status-info">Clique em <b>CHEGOU AGORA</b> quando o jogador chegar.</div>
          <div id="status-jogadores" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th>APELIDO</th>
                  <th style="width:170px">CHEGOU AGORA</th>
                </tr>
              </thead>
              <tbody id="tbody-jogadores-todos"></tbody>
            </table>
          </div>
          <div class="status-info" id="total-jogadores"></div>
        </div>
      </div>

      <div class="col-50">
        <div class="painel painel-presenca">
          <h2>Presença hoje</h2>

          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div class="status-info" id="status-presenca">Carregando...</div>
            <div>
              <span class="clock-box" id="data-jogo-box">Data do jogo: --/--/----</span>
              <span class="clock-box" style="margin-left:8px" id="hora-escalacao-box">Horário da escalação: 06:20</span>
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
            <button id="btn-limpar-hoje" class="btn-perigo">Limpar hoje</button>
            <button id="btn-escalar-1t" class="btn-primario">Escalar 1º tempo</button>
          <div id="hora-top" class="info-mini">Hora agora: <span id="hora-top-val">--:--</span></div>

            <!-- marcador pedido: acima do desfazer 1T -->
            <div style="display:flex;flex-direction:column;gap:6px">
              <div class="clock-box" id="agora-1t">Hora agora: --:--</div>
              <button id="btn-desfazer-1t" class="btn-neutro">Desfazer 1º tempo</button>
            </div>

            <button id="btn-baixar-presenca" class="btn-neutro">Baixar PDF</button>
          </div>

          <div class="painel-scroll" style="margin-top:10px">
            <table id="tbl-presenca">
              <thead>
                <tr>
                  <th style="width:60px">ID</th>
                  <th style="width:70px">ORDEM</th>
                  <th>APELIDO</th>
                  <th style="width:90px">HORA</th>
                  <th style="width:110px">OBS</th>
                  <th style="width:160px">NÃO VAI JOGAR</th>
                  <th style="width:110px">EXCLUIR</th>
                </tr>
              </thead>
              <tbody id="tbody-presenca"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="painel" id="painelEscalacao">
      <h2>Escalação do jogo</h2>
      <div class="status-info">OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) | <span style="color:#22c55e;font-weight:bold">P</span> (verde) pagou | <span style="color:#ef4444;font-weight:bold">P</span> (vermelho) não pagou</div>
      <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <span class="clock-box" id="agora-2t">Hora agora: --:--</span>
        <button id="btn-escalar-2t" class="btn-primario">Escalar 2º tempo</button>
        <button id="btn-desfazer-2t" class="btn-neutro">Desfazer 2º tempo</button>
        <button id="btn-baixar-1t" class="btn-neutro">Baixar PDF 1º tempo</button>
        <button id="btn-baixar-2t" class="btn-neutro">Baixar PDF 2º tempo</button>
        <button id="btn-salvar" class="btn-secundario">Salvar</button>
      </div>

      <div class="grid-escalacao" style="margin-top:10px">
        <div class="col-escalacao">
          <div class="status-info" style="font-weight:bold">1º TEMPO</div>
          <table id="tbl-1t">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th>AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th>AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-1t"></tbody>
          </table>
        </div>

        <div class="col-escalacao">
          <div class="status-info" style="font-weight:bold">2º TEMPO</div>
          <table id="tbl-2t">
            <thead>
              <tr>
                <th style="width:60px">ID</th>
                <th style="width:60px">POS</th>
                <th>AMARELO</th>
                <th>AZUL</th>
              </tr>
            </thead>
            <tbody id="tbody-2t"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

<script>
// =====================
// TESOURA - PRESENÇA / ESCALAÇÃO (FIX)
// =====================
function $(id){ return document.getElementById(id); }

function nextSundayYMD(){
  const d = new Date();
  const day = d.getDay(); // 0 domingo
  const add = (7 - day) % 7;
  const s = new Date(d.getFullYear(), d.getMonth(), d.getDate() + add);
  const y = s.getFullYear();
  const m = String(s.getMonth()+1).padStart(2,"0");
  const da = String(s.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}

function showClock(){
  const el = $("hora_agora");
  if (!el) return;
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");
  el.textContent = `${hh}:${mm}`;
}

function getDataDomingo(){
  const inp = $("data_jogo");
  return (inp?.value || "").trim();
}

async function postJson(url, body){
  const resp = await fetch(url, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body||{}),
  });
  const text = await resp.text();
  let data=null; try{ data=JSON.parse(text);}catch(_){}
  if (!resp.ok){
    const msg = data?.error ? String(data.error) : (text || `HTTP ${resp.status}`);
    throw new Error(msg);
  }
  return data;
}

async function loadJogadores(){
  const tb = $("tbJogadores");
  if (!tb) return;
  tb.innerHTML = "";
  try{
    const data = await apiGetJson("/api/jogadores");
    const lista = Array.isArray(data?.jogadores) ? data.jogadores : [];
    lista.forEach(j => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${j.id ?? ""}</td>
        <td style="color:#fff;font-weight:700">${j.apelido ?? ""}</td>
        <td><button class="btnChegou" data-id="${j.id}">CHEGOU AGORA</button></td>
      `;
      tb.appendChild(tr);
    });

    // bind chegou
    const table = $("tblJogadores");
    if (table && !table.__bound){
      table.__bound = true;
      table.addEventListener("click", async (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;
        if (!t.classList.contains("btnChegou")) return;
        const id = Number(t.getAttribute("data-id")||0);
        const data_domingo = getDataDomingo();
        if (!data_domingo) return alert("Defina a data do jogo.");
        try{
          await postJson("/api/presenca_escalacao/chegou", { id, data_domingo });
          await loadState();
        }catch(err){
          alert("Erro (CHEGOU AGORA): " + (err?.message || err));
        }
      });
    }
  }catch(err){
    alert("Falha ao carregar jogadores: " + (err?.message || err));
  }
}

function renderPresencas(presencas){
  const tb = $("tbPresenca");
  if (!tb) return;
  tb.innerHTML = "";
  presencas.forEach(p => {
    const tr = document.createElement("tr");
    const checked = p.nao_joga ? "checked" : "";
    tr.innerHTML = `
      <td>${p.id ?? ""}</td>
      <td>${p.ordem ?? ""}</td>
      <td style="color:#fff;font-weight:700">${p.apelido ?? ""}</td>
      <td>${p.hora ?? ""}</td>
      <td>${p.obs ?? ""}</td>
      <td><input type="checkbox" class="ckNao" data-id="${p.id}" ${checked}></td>
      <td><button class="btnRem" data-id="${p.id}">EXCLUIR</button></td>
    `;
    tb.appendChild(tr);
  });
  $("presenca_count") && ($("presenca_count").textContent = String(presencas.length));
}

function renderEscalacao(tbId, lista, tempo){
  const tb = $(tbId);
  if (!tb) return;
  tb.innerHTML = "";
  lista.forEach(e => {
    const tr = document.createElement("tr");
    const saiu = e.saiu ? "✅" : "";
    tr.innerHTML = `
      <td>${e.id ?? ""}</td>
      <td>${e.pos ?? ""}</td>
      <td style="color:#fff;font-weight:700">${e.amarelo ?? ""}</td>
      <td><button class="btnSaiu" data-id="${e.id}" data-tempo="${tempo}">SAIU</button> ${saiu}</td>
      <td style="color:#fff;font-weight:700">${e.azul ?? ""}</td>
      <td><button class="btnSaiu" data-id="${e.id}" data-tempo="${tempo}">SAIU</button> ${saiu}</td>
    `;
    tb.appendChild(tr);
  });
}

async function loadState(){
  const data_domingo = getDataDomingo();
  if (!data_domingo) return;
  try{
    const st = await apiGetJson(`/api/presenca_escalacao/state?data_domingo=${encodeURIComponent(data_domingo)}`);
    const presencas = Array.isArray(st?.presencas) ? st.presencas : [];
    const esc1 = Array.isArray(st?.escalacao1) ? st.escalacao1 : [];
    const esc2 = Array.isArray(st?.escalacao2) ? st.escalacao2 : [];
    renderPresencas(presencas);
    renderEscalacao("tb1t", esc1, "1T");
    renderEscalacao("tb2t", esc2, "2T");
    $("status_presenca") && ($("status_presenca").textContent = `Lista carregada. (Domingo: ${data_domingo})`);
  }catch(err){
    $("status_presenca") && ($("status_presenca").textContent = "Erro ao carregar lista.");
    alert("Falha ao carregar presença: " + (err?.message || err));
  }
}

async function onLimpar(){
  const data_domingo = getDataDomingo();
  if (!data_domingo) return;
  if (!confirm("Limpar a lista de hoje?")) return;
  try{
    await postJson("/api/presenca_escalacao/limpar", { data_domingo });
    await loadState();
  }catch(err){
    alert("Erro ao limpar: " + (err?.message || err));
  }
}

async function onEscalar(tempo){
  const data_domingo = getDataDomingo();
  if (!data_domingo) return;
  try{
    await postJson("/api/presenca_escalacao/escalar", { data_domingo, tempo });
    await loadState();
  }catch(err){
    alert(`Erro ao escalar ${tempo}: ` + (err?.message || err));
  }
}

async function onDesfazer(tempo){
  const data_domingo = getDataDomingo();
  if (!data_domingo) return;
  try{
    await postJson("/api/presenca_escalacao/desfazer", { data_domingo, tempo });
    await loadState();
  }catch(err){
    alert(`Erro ao desfazer ${tempo}: ` + (err?.message || err));
  }
}

async function onSalvar(){
  const data_domingo = getDataDomingo();
  if (!data_domingo) return;
  try{
    await postJson("/api/presenca_escalacao/salvar", { data_domingo });
    alert("SALVO no Banco de Dados.");
  }catch(err){
    alert("Erro ao salvar: " + (err?.message || err));
  }
}

function bindPresenceTableActions(){
  const tbl = $("tblPresenca");
  if (!tbl || tbl.__bound) return;
  tbl.__bound = true;

  tbl.addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;
    const id = Number(t.getAttribute("data-id")||0);
    const data_domingo = getDataDomingo();
    if (!data_domingo) return;

    if (t.classList.contains("btnRem")){
      if (!confirm("Excluir da lista?")) return;
      try{
        await postJson("/api/presenca_escalacao/remover", { id, data_domingo });
        await loadState();
      }catch(err){
        alert("Erro ao excluir: " + (err?.message || err));
      }
    }
  });

  tbl.addEventListener("change", async (ev) => {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;
    if (!t.classList.contains("ckNao")) return;
    const id = Number(t.getAttribute("data-id")||0);
    const data_domingo = getDataDomingo();
    const nao_joga = t.checked;
    try{
      await postJson("/api/presenca_escalacao/toggle_nao_joga", { id, data_domingo, nao_joga });
      await loadState();
    }catch(err){
      alert("Erro (não vai jogar): " + (err?.message || err));
    }
  });
}

function bindEscalacaoActions(){
  const box = document;
  if (box.__boundSaiu) return;
  box.__boundSaiu = true;

  document.addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;
    if (!t.classList.contains("btnSaiu")) return;
    const id = Number(t.getAttribute("data-id")||0);
    const tempo = String(t.getAttribute("data-tempo")||"");
    const data_domingo = getDataDomingo();
    if (!data_domingo) return;
    try{
      await postJson("/api/presenca_escalacao/toggle_saiu", { id, data_domingo, tempo });
      await loadState();
    }catch(err){
      alert("Erro (saiu): " + (err?.message || err));
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  // data default
  const inp = $("data_jogo");
  if (inp && !inp.value) inp.value = nextSundayYMD();

  // clock
  showClock();
  setInterval(showClock, 5000);

  // binds
  $("btnLimparHoje")?.addEventListener("click", onLimpar);
  $("btnEscalar1T")?.addEventListener("click", () => onEscalar("1T"));
  $("btnDesfazer1T")?.addEventListener("click", () => onDesfazer("1T"));
  $("btnEscalar2T")?.addEventListener("click", () => onEscalar("2T"));
  $("btnDesfazer2T")?.addEventListener("click", () => onDesfazer("2T"));
  $("btnSalvar")?.addEventListener("click", onSalvar);

  $("data_jogo")?.addEventListener("change", async () => { await loadState(); });

  bindPresenceTableActions();
  bindEscalacaoActions();

  loadJogadores();
  loadState();
});
</script>

</body>
</html>