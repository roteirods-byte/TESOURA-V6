<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>TESOURA - PRESENÇA / ESCALAÇÃO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body{margin:0;padding:0;font-family:Arial,sans-serif;background:#0f172a;color:#f9fafb;font-size:12px}
    header{background:#020617;padding:12px 16px;text-align:center;font-weight:bold;letter-spacing:1px;text-transform:uppercase}
    .container{max-width:1400px;margin:0 auto;padding:16px}
    h2{margin:8px 0;color:#f97316;text-transform:uppercase}
    .painel{background:#020617;border-radius:10px;padding:10px;box-shadow:0 2px 10px rgba(0,0,0,0.35);margin-bottom:14px}
    .linhas-topo{display:flex;gap:16px;margin-bottom:16px}
    .col-50{flex:1;min-width:0}

    table{width:100%;border-collapse:collapse;margin-top:8px;background:#020617;font-size:11px}
    th,td{border:1px solid #334155;padding:2px 4px;text-align:center;text-transform:uppercase;white-space:nowrap;font-size:11px}
    th{background:#111827;color:#f97316;position:sticky;top:0;z-index:1}
    tr:nth-child(even){background:#0b1120}
    tr:nth-child(odd){background:#020617}
    .painel-scroll{overflow-y:auto;max-height:320px}
    .status-info{font-size:12px;margin-top:6px;color:#cbd5e1}
    .riscado{text-decoration:line-through;opacity:.55}

    button{
      padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-weight:bold;
      text-transform:uppercase;font-size:11px;line-height:1;height:30px;min-width:110px
    }
    .btn-primario{background:#22c55e;color:#022c22}
    .btn-secundario{background:#0ea5e9;color:#0f172a}
    .btn-perigo{background:#ef4444;color:#f9fafb}
    .btn-neutro{background:#f97316;color:#0f172a}
    .btn-chegou{background:#10b981;color:#022c22;min-width:120px}
    .btn-nao-joga{background:#64748b;color:#e5e7eb;min-width:140px}
    .btn-excluir{background:#ef4444;color:#f9fafb;min-width:90px}
    .btn-saiu{
      min-width:56px !important;height:24px !important;font-size:10px !important;padding:0 8px !important;
      line-height:1 !important;background:#22c55e;color:#0b1220;border:1px solid rgba(34,197,94,0.6);
      border-radius:8px;cursor:pointer;
    }

    .row-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .badge{
      display:inline-block;padding:6px 10px;border:1px solid rgba(148,163,184,0.25);
      border-radius:10px;background:rgba(15,23,42,0.35);color:#cbd5e1;font-size:12px
    }

    .grid-escalacao{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    @media (max-width: 980px){.linhas-topo{flex-direction:column}.grid-escalacao{grid-template-columns:1fr}}

    .t-amarelo{color:#facc15;font-weight:bold}
    .t-azul{color:#38bdf8;font-weight:bold}

    /* PDF (não é print: é tabela gerada no jsPDF) */
  </style>

  <!-- jsPDF + AutoTable (para PDF ARQUIVO REAL) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <header>TESOURA - PRESENÇA / ESCALAÇÃO</header>

  <div class="container">
    <div class="linhas-topo">

      <!-- JOGADORES -->
      <div class="col-50">
        <div class="painel">
          <h2>Jogadores (todos)</h2>
          <div class="status-info">Clique em <b>CHEGOU AGORA</b> quando o jogador chegar.</div>
          <div id="status-jogadores" class="status-info"></div>

          <div class="painel-scroll">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th>APELIDO</th>
                  <th style="width:170px">CHEGOU AGORA</th>
                </tr>
              </thead>
              <tbody id="tbody-jogadores"></tbody>
            </table>
          </div>

          <div class="status-info" id="total-jogadores"></div>
        </div>
      </div>

      <!-- PRESENÇA -->
      <div class="col-50">
        <div class="painel">
          <h2>Presença Hoje</h2>

          <div class="row-actions">
            <span class="badge">Data do jogo: <b id="data-jogo">--/--/----</b></span>
            <span class="badge">Horário da escalação: <b>06:20</b></span>
            <span class="badge">Presentes: <b id="total-presenca">0</b></span>
          </div>

          <div class="row-actions">
            <button class="btn-perigo" id="btn-limpar">LIMPAR HOJE</button>
            <button class="btn-primario" id="btn-escalar-1t">ESCALAR 1º TEMPO</button>

            <!-- pedido #2: marcador de hora acima do DESFAZER 1T -->
            <span class="badge" id="clock-1t">Hora agora: --:--</span>
            <button class="btn-neutro" id="btn-desfazer-1t">DESFAZER 1º TEMPO</button>

            <button class="btn-neutro" id="btn-pdf-presenca">BAIXAR PDF (PRESENÇA)</button>
          </div>

          <div id="status-presenca" class="status-info"></div>

          <div class="painel-scroll" style="max-height:360px">
            <table>
              <thead>
                <tr>
                  <th style="width:70px">ID</th>
                  <th style="width:70px">ORDEM</th>
                  <th>APELIDO</th>
                  <th style="width:90px">HORA</th>
                  <th style="width:90px">OBS</th>
                  <th style="width:150px">NÃO VAI JOGAR</th>
                  <th style="width:110px">EXCLUIR</th>
                </tr>
              </thead>
              <tbody id="tbody-presenca"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <!-- ESCALAÇÃO -->
    <div class="painel">
      <h2>Escalação do Jogo</h2>

      <div class="row-actions">
        <span class="badge" id="clock-2t">Hora agora: --:--</span>
        <button class="btn-primario" id="btn-escalar-2t">ESCALAR 2º TEMPO</button>
        <button class="btn-neutro" id="btn-desfazer-2t">DESFAZER 2º TEMPO</button>
        <button class="btn-neutro" id="btn-pdf-1t">BAIXAR PDF 1º TEMPO</button>
        <button class="btn-neutro" id="btn-pdf-2t">BAIXAR PDF 2º TEMPO</button>
        <button class="btn-secundario" id="btn-salvar">SALVAR</button>
      </div>

      <div class="status-info">
        OBS: C (compareceu e não jogou) | F (faltou) | 1 (jogou 1º) | 2 (jogou 2º) | 1-2 (jogou os dois) | <span style="color:#22c55e;font-weight:bold">P</span> (pagou) | <span style="color:#ef4444;font-weight:bold">P</span> (não pagou)
      </div>

      <div class="grid-escalacao">
        <!-- 1T -->
        <div class="painel" style="margin:0">
          <h2>1º Tempo</h2>
          <div class="status-info">Botão <b>SAIU</b> risca o nome.</div>
          <table>
            <thead>
              <tr>
                <th style="width:50px">POS</th>
                <th class="t-amarelo">AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th class="t-azul">AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-1t"></tbody>
          </table>
        </div>

        <!-- 2T -->
        <div class="painel" style="margin:0">
          <h2>2º Tempo</h2>
          <div class="status-info">Prioridade: quem não jogou.</div>
          <table>
            <thead>
              <tr>
                <th style="width:50px">POS</th>
                <th class="t-amarelo">AMARELO</th>
                <th style="width:70px">SAIU</th>
                <th class="t-azul">AZUL</th>
                <th style="width:70px">SAIU</th>
              </tr>
            </thead>
            <tbody id="tbody-2t"></tbody>
          </table>
        </div>
      </div>

      <div id="status-escalacao" class="status-info"></div>
    </div>
  </div>

<script>
/* ========= UTIL ========= */
function pad2(n){ return String(n).padStart(2,"0"); }
function ymd(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function ymdToBr(s){
  s = String(s||"").trim();
  if(!s) return "";
  if(s.includes("/")) return s;
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m) return `${m[3]}/${m[2]}/${m[1]}`;
  return s;
}
function nowHHMM(){
  const d=new Date();
  return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
// Próximo domingo (inclui hoje se já for domingo)
function proximoDomingoISO(){
  const d = new Date();
  const dow = d.getDay(); // 0=domingo
  const add = (7 - dow) % 7;
  d.setDate(d.getDate() + add);
  return ymd(d);
}
function nowLocalStr(){
  const d = new Date();
  return `${ymd(d)} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

/* ========= API (robusta: não quebra com HTML/404) ========= */
async function safeFetch(url, opt){
  const r = await fetch(url, opt || {});
  const ct = (r.headers.get("content-type")||"").toLowerCase();
  let data = null;
  if(ct.includes("application/json")){
    data = await r.json().catch(()=>null);
  } else {
    const t = await r.text().catch(()=> "");
    data = { ok:false, error:`Resposta não-JSON (${r.status})`, raw:(t||"").slice(0,200) };
  }
  return { r, data };
}
async function apiGet(url){
  return safeFetch(url, { method:"GET" });
}
async function apiPost(url, body){
  return safeFetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body || {})
  });
}
// tenta vários endpoints (pra acabar com “misterio” de 404 de rota)
async function apiPostTry(urls, body){
  for(const u of urls){
    const { r, data } = await apiPost(u, body);
    if(r.ok && data && data.ok !== false) return { ok:true, url:u, data };
  }
  return { ok:false };
}

/* ========= ESTADO ========= */
let STATE = {
  data_domingo: proximoDomingoISO(),
  jogadores: [],
  presenca: [],
  esc1t: { amarelo:[], azul:[], saiuA:{}, saiuB:{} },
  esc2t: { amarelo:[], azul:[], saiuA:{}, saiuB:{} }
};

const elData = document.getElementById("data-jogo");
const elTotalPres = document.getElementById("total-presenca");
const elStatusJ = document.getElementById("status-jogadores");
const elStatusP = document.getElementById("status-presenca");
const elStatusE = document.getElementById("status-escalacao");
const elTotalJog = document.getElementById("total-jogadores");

function setStatus(el, msg){ el.textContent = msg || ""; }

/* ========= CARREGAR / SALVAR ========= */
async function carregarState(){
  STATE.data_domingo = proximoDomingoISO();
  elData.textContent = ymdToBr(STATE.data_domingo);

  const url = `/api/presenca_escalacao/state?data_domingo=${encodeURIComponent(STATE.data_domingo)}&now_local=${encodeURIComponent(nowLocalStr())}`;
  const { r, data } = await apiGet(url);

  if(!r.ok || !data || data.ok === false){
    setStatus(elStatusP, "ERRO ao carregar state.");
    // mantém o que tiver em memória (não trava painel)
    return;
  }

  // aceita vários formatos (para não depender do backend)
  const st = data.state || data.data || data;

  STATE.jogadores = Array.isArray(st.jogadores) ? st.jogadores : (Array.isArray(data.jogadores)?data.jogadores:[]);
  STATE.presenca  = Array.isArray(st.presenca) ? st.presenca : (Array.isArray(st.presentes)?st.presentes:[]);
  // normaliza presença
  STATE.presenca = STATE.presenca.map((p, idx)=>({
    id: p.id ?? p.jogador_id ?? p.player_id ?? 0,
    apelido: (p.apelido || p.nome || "").toUpperCase(),
    ordem: Number(p.ordem ?? (idx+1)),
    hora: (p.hora || p.hhmm || ""),
    obs: (p.obs || ""),
    nao_joga: !!(p.nao_joga ?? p.nao_vai_jogar ?? p.naoJoga),
    jogou1t: !!p.jogou1t,
    jogou2t: !!p.jogou2t
  }));

  // escalações se vierem do backend
  const esc1 = st.esc1t || st.escalacao_1t || st.escalacao1t;
  const esc2 = st.esc2t || st.escalacao_2t || st.escalacao2t;
  if(esc1 && esc1.amarelo && esc1.azul) STATE.esc1t = esc1;
  if(esc2 && esc2.amarelo && esc2.azul) STATE.esc2t = esc2;

  renderAll();
  setStatus(elStatusP, `OK: state carregado (domingo: ${ymdToBr(STATE.data_domingo)})`);
}

async function salvarState(motivo){
  // tenta salvar em várias rotas possíveis
  const body = {
    ok:true,
    data_domingo: STATE.data_domingo,
    now_local: nowLocalStr(),
    state: STATE,
    motivo: motivo || "update"
  };

  const tryUrls = [
    "/api/presenca_escalacao/salvar",
    "/api/presenca_escalacao/save",
    "/api/presenca_escalacao/state",
    "/api/presenca_escalacao/update"
  ];

  const res = await apiPostTry(tryUrls, body);
  if(!res.ok){
    // não trava — mas avisa
    setStatus(elStatusE, "AVISO: não consegui salvar no servidor (rotas não encontradas).");
    return false;
  }
  setStatus(elStatusE, `OK: salvo (${motivo || "update"})`);
  return true;
}

/* ========= RENDER ========= */
function renderAll(){
  renderJogadores();
  renderPresenca();
  renderEscalacao();
}

function renderJogadores(){
  const tb = document.getElementById("tbody-jogadores");
  tb.innerHTML = "";

  const jogadores = Array.isArray(STATE.jogadores) ? STATE.jogadores : [];
  elTotalJog.textContent = `TOTAL DE JOGADORES: ${jogadores.length}`;

  if(!jogadores.length){
    setStatus(elStatusJ, "Nenhum jogador no state.");
    return;
  }
  setStatus(elStatusJ, "");

  jogadores.forEach(j=>{
    const id = j.id ?? j.jogador_id ?? 0;
    const apelido = (j.apelido || j.nome || "").toUpperCase();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${id}</td>
      <td style="text-align:left;padding-left:8px">${apelido}</td>
      <td><button class="btn-chegou" data-id="${id}" data-apelido="${apelido}">CHEGOU AGORA</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.getAttribute("data-id"));
      const apelido = String(btn.getAttribute("data-apelido")||"").toUpperCase();
      addPresenca(id, apelido);
      renderPresenca();
      await salvarState("chegou_agora");
    };
  });
}

function renderPresenca(){
  const tb = document.getElementById("tbody-presenca");
  tb.innerHTML = "";

  // ordena por ordem
  STATE.presenca.sort((a,b)=>a.ordem-b.ordem);
  // renumera ordem (regra #7)
  STATE.presenca.forEach((p,i)=>p.ordem=i+1);

  elTotalPres.textContent = String(STATE.presenca.length);

  STATE.presenca.forEach(p=>{
    const tr = document.createElement("tr");
    if(p.nao_joga) tr.classList.add("riscado");

    const txtNao = p.nao_joga ? "VAI JOGAR" : "NÃO VAI JOGAR";

    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.ordem}</td>
      <td style="text-align:left;padding-left:8px">${p.apelido}</td>
      <td>${p.hora || ""}</td>
      <td>${p.obs || ""}</td>
      <td><button class="btn-nao-joga" data-act="nao" data-id="${p.id}">${txtNao}</button></td>
      <td><button class="btn-excluir" data-act="exc" data-id="${p.id}">EXCLUIR</button></td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("button[data-act='nao']").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.getAttribute("data-id"));
      const p = STATE.presenca.find(x=>x.id===id);
      if(!p) return;

      // regra #3: riscar e impedir escalação
      p.nao_joga = !p.nao_joga;

      renderPresenca();
      const ok = await salvarState("toggle_nao_joga");
      if(!ok) alert("Erro ao alterar NÃO VAI JOGAR.");
    };
  });

  tb.querySelectorAll("button[data-act='exc']").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.getAttribute("data-id"));
      STATE.presenca = STATE.presenca.filter(x=>x.id!==id);

      // também remove de escalações, se existir
      removeFromEscalacao(id);

      renderAll();
      const ok = await salvarState("excluir_presenca");
      if(!ok) alert("Erro ao excluir.");
    };
  });
}

function renderEscalacao(){
  const tb1 = document.getElementById("tbody-1t");
  const tb2 = document.getElementById("tbody-2t");
  tb1.innerHTML = "";
  tb2.innerHTML = "";

  // garante 10 posições
  const POS = 10;

  for(let i=1;i<=POS;i++){
    const a = STATE.esc1t.amarelo[i-1] || "";
    const b = STATE.esc1t.azul[i-1] || "";
    const saiuA = !!STATE.esc1t.saiuA?.[i];
    const saiuB = !!STATE.esc1t.saiuB?.[i];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i}</td>
      <td class="${saiuA ? "riscado":""}" style="text-align:left;padding-left:8px">${a}</td>
      <td><button class="btn-saiu" data-t="1" data-team="A" data-pos="${i}">SAIU</button></td>
      <td class="${saiuB ? "riscado":""}" style="text-align:left;padding-left:8px">${b}</td>
      <td><button class="btn-saiu" data-t="1" data-team="B" data-pos="${i}">SAIU</button></td>
    `;
    tb1.appendChild(tr);
  }

  for(let i=1;i<=POS;i++){
    const a = STATE.esc2t.amarelo[i-1] || "";
    const b = STATE.esc2t.azul[i-1] || "";
    const saiuA = !!STATE.esc2t.saiuA?.[i];
    const saiuB = !!STATE.esc2t.saiuB?.[i];

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i}</td>
      <td class="${saiuA ? "riscado":""}" style="text-align:left;padding-left:8px">${a}</td>
      <td><button class="btn-saiu" data-t="2" data-team="A" data-pos="${i}">SAIU</button></td>
      <td class="${saiuB ? "riscado":""}" style="text-align:left;padding-left:8px">${b}</td>
      <td><button class="btn-saiu" data-t="2" data-team="B" data-pos="${i}">SAIU</button></td>
    `;
    tb2.appendChild(tr);
  }

  // handlers SAIU (risca o nome)
  document.querySelectorAll("button.btn-saiu").forEach(btn=>{
    btn.onclick = async ()=>{
      const t = btn.getAttribute("data-t"); // "1" ou "2"
      const team = btn.getAttribute("data-team"); // A/B
      const pos = Number(btn.getAttribute("data-pos"));

      const esc = (t==="1") ? STATE.esc1t : STATE.esc2t;
      if(!esc.saiuA) esc.saiuA = {};
      if(!esc.saiuB) esc.saiuB = {};

      if(team==="A") esc.saiuA[pos] = !esc.saiuA[pos];
      if(team==="B") esc.saiuB[pos] = !esc.saiuB[pos];

      renderEscalacao();
      await salvarState(`saiu_${t}t`);
    };
  });
}

/* ========= AÇÕES ========= */
function addPresenca(id, apelido){
  // evita duplicar no mesmo dia (regra #5)
  if(STATE.presenca.some(p=>p.id===id)){
    setStatus(elStatusP, "Jogador já está na lista.");
    return;
  }
  setStatus(elStatusP, "");
  STATE.presenca.push({
    id, apelido,
    ordem: STATE.presenca.length + 1,
    hora: nowHHMM(),
    obs: "",
    nao_joga:false,
    jogou1t:false,
    jogou2t:false
  });
}

function removeFromEscalacao(id){
  const apelido = (STATE.presenca.find(p=>p.id===id)?.apelido || "").toUpperCase();
  // remove pelo apelido (sem depender de id na escalação)
  [STATE.esc1t, STATE.esc2t].forEach(esc=>{
    esc.amarelo = (esc.amarelo||[]).map(n => (n===apelido ? "" : n));
    esc.azul    = (esc.azul||[]).map(n => (n===apelido ? "" : n));
  });
}

function escalarTempo(tempo){
  const POS = 10; // 10x2 = 20 jogadores
  const max = POS*2;

  const elegiveis = STATE.presenca
    .filter(p=>!p.nao_joga)
    .sort((a,b)=>a.ordem-b.ordem);

  let fila = [];
  if(tempo===1){
    fila = elegiveis.slice(0, max);
    // marca jogou1t
    fila.forEach(p=>p.jogou1t=true);
  } else {
    // prioridade quem não jogou 1T
    const naoJogou = elegiveis.filter(p=>!p.jogou1t);
    const jaJogou  = elegiveis.filter(p=>p.jogou1t);
    fila = naoJogou.concat(jaJogou).slice(0, max);
    fila.forEach(p=>p.jogou2t=true);
  }

  const a = [];
  const b = [];
  fila.forEach((p, i)=>{
    // alterna pra equilibrar
    if(i%2===0) a.push(p.apelido);
    else b.push(p.apelido);
  });

  const esc = (tempo===1) ? STATE.esc1t : STATE.esc2t;
  esc.amarelo = [];
  esc.azul = [];
  esc.saiuA = {};
  esc.saiuB = {};

  for(let i=0;i<POS;i++){
    esc.amarelo[i] = a[i] || "";
    esc.azul[i] = b[i] || "";
  }
}

function desfazerTempo(tempo){
  const esc = (tempo===1) ? STATE.esc1t : STATE.esc2t;
  esc.amarelo = [];
  esc.azul = [];
  esc.saiuA = {};
  esc.saiuB = {};

  if(tempo===1){
    STATE.presenca.forEach(p=>p.jogou1t=false);
  } else {
    STATE.presenca.forEach(p=>p.jogou2t=false);
  }
}

/* ========= PDF (ARQUIVO REAL) ========= */
function ensurePDF(){
  if(!window.jspdf || !window.jspdf.jsPDF) return false;
  return true;
}
function pdfName(prefix){
  const d = ymdToBr(STATE.data_domingo).replaceAll("/","-");
  return `${prefix}_${d}.pdf`;
}

function pdfPresenca(){
  if(!ensurePDF()){
    alert("PDF: biblioteca não carregou.");
    return;
  }
  const doc = new window.jspdf.jsPDF({orientation:"landscape", unit:"pt", format:"a4"});

  const title = `PRESENÇA HOJE - DOMINGO ${ymdToBr(STATE.data_domingo)} - GERADO ${nowHHMM()}`;
  doc.setFontSize(12);
  doc.text(title, 40, 30);

  const rows = STATE.presenca
    .sort((a,b)=>a.ordem-b.ordem)
    .map(p=>[
      String(p.id||""),
      String(p.ordem||""),
      String(p.apelido||""),
      String(p.hora||""),
      String(p.obs||""),
      p.nao_joga ? "SIM" : ""
    ]);

  doc.autoTable({
    startY: 50,
    head: [[ "ID","ORDEM","APELIDO","HORA","OBS","NÃO VAI JOGAR" ]],
    body: rows,
    styles: { fontSize: 9, cellPadding: 3 },
    headStyles: { fillColor: [255,127,39] }
  });

  doc.save(pdfName("TESOURA-PRESENCA"));
}

function pdfEscalacao(tempo){
  if(!ensurePDF()){
    alert("PDF: biblioteca não carregou.");
    return;
  }
  const doc = new window.jspdf.jsPDF({orientation:"landscape", unit:"pt", format:"a4"});

  const esc = (tempo===1) ? STATE.esc1t : STATE.esc2t;
  const title = `ESCALAÇÃO ${tempo}º TEMPO - DOMINGO ${ymdToBr(STATE.data_domingo)} - GERADO ${nowHHMM()}`;
  doc.setFontSize(12);
  doc.text(title, 40, 30);

  const POS = 10;
  const rows = [];
  for(let i=1;i<=POS;i++){
    rows.push([
      String(i),
      String(esc.amarelo?.[i-1] || ""),
      String(esc.azul?.[i-1] || "")
    ]);
  }

  doc.autoTable({
    startY: 50,
    head: [[ "POS","AMARELO","AZUL" ]],
    body: rows,
    styles: { fontSize: 10, cellPadding: 4 },
    headStyles: { fillColor: [255,127,39] }
  });

  doc.save(pdfName(tempo===1 ? "TESOURA-ESCALACAO-1T" : "TESOURA-ESCALACAO-2T"));
}

/* ========= BOTÕES ========= */
document.getElementById("btn-limpar").onclick = async ()=>{
  STATE.presenca = [];
  desfazerTempo(1);
  desfazerTempo(2);
  renderAll();
  await salvarState("limpar_hoje");
};

document.getElementById("btn-escalar-1t").onclick = async ()=>{
  escalarTempo(1);
  renderAll();
  const ok = await salvarState("escalar_1t");
  if(!ok) alert("Erro ao escalar 1º tempo.");
};

document.getElementById("btn-desfazer-1t").onclick = async ()=>{
  desfazerTempo(1);
  renderAll();
  await salvarState("desfazer_1t");
};

document.getElementById("btn-escalar-2t").onclick = async ()=>{
  escalarTempo(2);
  renderAll();
  const ok = await salvarState("escalar_2t");
  if(!ok) alert("Erro ao escalar 2º tempo.");
};

document.getElementById("btn-desfazer-2t").onclick = async ()=>{
  desfazerTempo(2);
  renderAll();
  await salvarState("desfazer_2t");
};

document.getElementById("btn-pdf-presenca").onclick = pdfPresenca;
document.getElementById("btn-pdf-1t").onclick = ()=>pdfEscalacao(1);
document.getElementById("btn-pdf-2t").onclick = ()=>pdfEscalacao(2);

document.getElementById("btn-salvar").onclick = async ()=>{
  const ok = await salvarState("salvar");
  if(!ok) alert("Aviso: não consegui salvar no servidor.");
};

/* ========= CLOCKS ========= */
function tickClock(){
  const t = nowHHMM();
  document.getElementById("clock-1t").textContent = `Hora agora: ${t}`;
  document.getElementById("clock-2t").textContent = `Hora agora: ${t}`;
}
setInterval(tickClock, 1000);
tickClock();

/* ========= START ========= */
(async ()=>{
  elData.textContent = ymdToBr(STATE.data_domingo);
  await carregarState();
})();
</script>
</body>
</html>
