<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA - JOGADORES</title>

  <style>
    :root{
      --bg:#061226;
      --card:#0b1932;
      --line:#243552;
      --txt:#e6eefc;
      --muted:#9bb0d1;
      --orange:#f28c28;
      --green:#22c55e;
      --blue:#22a3ff;
      --red:#ff3b3b;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #0b1b3a 0%, var(--bg) 55%, #040b18 100%);
      color:var(--txt);
    }

    .container{ max-width: 1180px; margin: 18px auto 30px; padding: 0 14px; }
    h1{ margin:0 0 10px; font-size:22px; letter-spacing:.4px; color:var(--orange); }

    .rev{
      color:var(--green);
      font-weight:900;
      margin: 6px 0 12px;
      font-size: 13px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    /* Barra de ajuda */
    .helpbar{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom: 12px;
      color: #cfe0ff;
      font-weight: 800;
      font-size: 12px;
    }

    /* ===== FORM (usando seu esquema de larguras) ===== */
    .form-grid{
      display:grid;
      grid-template-columns: 70px 220px 140px 110px; /* Camisa, Nome, Apelido, Data Nasc */
      gap: 10px 12px;
      align-items:end;
    }

    .field label{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color:#cfe0ff;
      margin: 0 0 6px;
      letter-spacing:.2px;
    }

    input{
      width:100%;
      height: 34px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
    }
    input::placeholder{ color: rgba(230,238,252,.45); font-weight:700; }

    .row2{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 140px 60px 60px 60px; /* Celular, Posição, Hab, Vel */
      gap: 10px 12px;
      align-items:end;
    }

    .row3{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 60px 60px 1fr; /* Mov, Pontos, Botões */
      gap: 10px 12px;
      align-items:end;
    }

    .btns{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    .btn{
      height: 36px;
      min-width: 110px;
      padding: 0 14px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .btn-save{ background: var(--green); color:#05210f; }
    .btn-clear{ background: var(--orange); color:#2a1200; }
    .btn-pdf{ background: var(--blue); color:#001a2a; }

    .status{
      margin: 10px 2px 0;
      font-weight: 900;
      font-size: 12px;
    }
    .status.ok{ color: var(--green); }
    .status.err{ color: var(--red); }

    .total{
      margin: 4px 2px 0;
      font-weight: 900;
      font-size: 12px;
      color: #ffffff;
    }

    /* ===== ANIVERSARIANTES (larguras fixas: 100 / 60 / 60) ===== */
    .bday-card{
      margin-top: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px 12px;
    }
    .bday-title{
      color: var(--orange);
      font-weight: 900;
      margin: 0 0 10px;
      font-size: 13px;
      letter-spacing:.25px;
    }

    .bday-table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      overflow:hidden;
      border-radius: 12px;
    }
    .bday-table th, .bday-table td{
      border: 1px solid rgba(255,255,255,.10);
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
    }
    .bday-table th{
      color: var(--orange);
      background: rgba(0,0,0,.20);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing:.4px;
    }
    .bday-table th:nth-child(1), .bday-table td:nth-child(1){ width: 100px; }
    .bday-table th:nth-child(2), .bday-table td:nth-child(2){ width: 60px; text-align:center; }
    .bday-table th:nth-child(3), .bday-table td:nth-child(3){ width: 60px; text-align:center; }

    /* ===== TABELA PRINCIPAL (larguras do seu esquema) ===== */
    .table-wrap{
      margin-top: 14px;
      border-radius: 14px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      max-height: 520px;
    }

    table.main{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 1180px;
    }

    table.main th, table.main td{
      border: 1px solid rgba(255,255,255,.10);
      padding: 8px 8px;
      font-size: 12px;
      font-weight: 900;
      color: var(--txt);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    table.main th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(0,0,0,.28);
      color: var(--orange);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .45px;
    }

    .center{ text-align:center; }
    .btn-mini{
      height: 30px;
      min-width: 110px;
      padding: 0 12px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .btn-edit{ background: #22a3ff; color:#001a2a; }
    .btn-del{ background: #ff3b3b; color:#2a0000; }

    /* Print */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .container{ max-width:none; margin:0; padding:0; }
      .card{ box-shadow:none; border:1px solid #ddd; }
      table.main, .table-wrap{ max-height:none !important; overflow: visible !important; }
      *{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>TESOURA - JOGADORES</h1>

    <div class="rev">REV JOGADORES: 16/01 11:25</div>

    <div class="card">
      <div class="no-print">
        <div class="helpbar">
          <span>POSIÇÃO (Z/L/M/A): ZAGUEIRO / LATERAL / MEIO / ATAQUE</span>
          <span>HABILIDADE (1–5)</span>
          <span>VELOCIDADE (1–L, 2–N, 3–I)</span>
          <span>MOVIMENTAÇÃO (1–P, 2–N, 3–I)</span>
        </div>

        <!-- FORM -->
        <div class="form-grid">
          <div class="field">
            <label>CAMISA</label>
            <input id="camisa" placeholder="N°" inputmode="numeric" />
          </div>

          <div class="field">
            <label>NOME</label>
            <input id="nome" placeholder="Nome completo" />
          </div>

          <div class="field">
            <label>APELIDO (ÚNICO)*</label>
            <input id="apelido" placeholder="Apelido" />
          </div>

          <div class="field">
            <label>NASCIMENTO</label>
            <input id="nascimento" placeholder="AAAA-MM-DD" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>CELULAR</label>
            <input id="celular" placeholder="DDD + número" />
          </div>

          <div class="field">
            <label>POSIÇÃO (Z/L/M/A)</label>
            <!-- PEDIDO: SEM DROPDOWN, DIGITÁVEL -->
            <input id="posicao" placeholder="Z/L/M/A" maxlength="1" />
          </div>

          <div class="field">
            <label>HABILIDADE (1–5)</label>
            <input id="hab" placeholder="1-5" inputmode="numeric" />
          </div>

          <div class="field">
            <label>VELOCIDADE (1–3)</label>
            <input id="vel" placeholder="1-3" inputmode="numeric" />
          </div>
        </div>

        <div class="row3">
          <div class="field">
            <label>MOVIMENTAÇÃO (1–3)</label>
            <input id="mov" placeholder="1-3" inputmode="numeric" />
          </div>

          <div class="field">
            <label>PONTOS</label>
            <input id="pontos" placeholder="0" inputmode="numeric" />
          </div>

          <div class="btns">
            <button class="btn btn-save" id="btnSalvar">SALVAR</button>
            <button class="btn btn-clear" id="btnLimpar">LIMPAR</button>
            <button class="btn btn-pdf" id="btnPdf">BAIXAR PDF</button>
          </div>
        </div>

        <div id="status" class="status ok">OK: lista carregada</div>
        <div class="total" id="total">TOTAL DE JOGADORES: 0</div>
      </div>

      <!-- ANIVERSARIANTES -->
      <div class="bday-card" id="bdayBox">
        <div class="bday-title" id="bdayTitle">ANIVERSARIANTES DO MÊS</div>
        <div id="bdayContent">Carregando...</div>
      </div>

      <!-- TABELA -->
      <div class="table-wrap">
        <table class="main" id="tbl">
          <colgroup>
            <col style="width:60px" />
            <col style="width:70px" />
            <col style="width:140px" />
            <col style="width:220px" />
            <col style="width:110px" />
            <col style="width:70px" />
            <col style="width:140px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:110px" />
            <col style="width:110px" />
          </colgroup>
          <thead>
            <tr>
              <th class="center">ORDEM</th>
              <th class="center">CAMISA</th>
              <th>APELIDO</th>
              <th>NOME</th>
              <th class="center">DATA NASC.</th>
              <th class="center">IDADE</th>
              <th>CELULAR</th>
              <th class="center">POSIÇÃO</th>
              <th class="center">HAB</th>
              <th class="center">VEL</th>
              <th class="center">MOV</th>
              <th class="center">PONTOS</th>
              <th class="center">EDITAR</th>
              <th class="center">EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== API (tenta manter compatível) =====
    const API_BASES = [
      "/api/jogadores",
      "/api/jogadores/",
    ];

    function setStatusOk(msg){
      const el = document.getElementById("status");
      el.className = "status ok";
      el.textContent = msg;
    }
    function setStatusErr(msg){
      const el = document.getElementById("status");
      el.className = "status err";
      el.textContent = msg;
    }

    function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }

    function calcIdade(yyyy_mm_dd){
      if(!yyyy_mm_dd || yyyy_mm_dd.length < 10) return "";
      const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
      if(!y||!m||!d) return "";
      const birth = new Date(y, m-1, d);
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const mm = today.getMonth() - birth.getMonth();
      if (mm < 0 || (mm === 0 && today.getDate() < birth.getDate())) age--;
      return String(age);
    }

    async function apiFetch(path, opts={}){
      let lastErr = null;
      for(const base of API_BASES){
        try{
          const url = base.endsWith("/") ? (base + path.replace(/^\//,"")) : (base + path);
          const res = await fetch(url, opts);
          if(res.status === 404){
            lastErr = new Error("404 em " + url);
            continue;
          }
          return res;
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Falha na API");
    }

    async function loadList(){
      const res = await apiFetch("", { cache:"no-store" });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error("Erro ao carregar lista: " + res.status + " " + txt);
      }
      const data = await res.json();
      // aceita formatos comuns:
      // 1) {lista:[...]}
      // 2) [...]
      const lista = Array.isArray(data) ? data : (data.lista || data.jogadores || []);
      renderList(lista);
      renderBdays(lista);
      document.getElementById("total").textContent = "TOTAL DE JOGADORES: " + lista.length;
      setStatusOk("OK: lista carregada");
      return lista;
    }

    function normPos(v){
      v = (v||"").trim().toUpperCase();
      if(!v) return "";
      const one = v[0];
      return one;
    }

    function getForm(){
      const camisa = onlyDigits(document.getElementById("camisa").value.trim());
      const nome = document.getElementById("nome").value.trim();
      const apelido = document.getElementById("apelido").value.trim();
      const nascimento = document.getElementById("nascimento").value.trim();
      const celular = document.getElementById("celular").value.trim();
      const posicao = normPos(document.getElementById("posicao").value);
      const hab = onlyDigits(document.getElementById("hab").value.trim());
      const vel = onlyDigits(document.getElementById("vel").value.trim());
      const mov = onlyDigits(document.getElementById("mov").value.trim());
      const pontos = onlyDigits(document.getElementById("pontos").value.trim()) || "0";

      return { camisa, nome, apelido, nascimento, celular, posicao, hab, vel, mov, pontos };
    }

    function clearForm(){
      ["camisa","nome","apelido","nascimento","celular","posicao","hab","vel","mov","pontos"].forEach(id=>{
        document.getElementById(id).value = "";
      });
      document.getElementById("pontos").value = "0";
    }

    // ===== RENDER =====
    function renderList(lista){
      // ordena por apelido (como no modelo)
      const rows = [...lista].sort((a,b)=>{
        const aa = (a.apelido||"").toUpperCase();
        const bb = (b.apelido||"").toUpperCase();
        return aa.localeCompare(bb);
      });

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      rows.forEach((p, idx)=>{
        const tr = document.createElement("tr");

        const id = p.id ?? p.ID ?? p._id ?? null;
        const camisa = p.camisa ?? "";
        const apelido = p.apelido ?? "";
        const nome = p.nome ?? "";
        const nascimento = (p.nascimento ?? p.nasc ?? p.data_nasc ?? "").toString();
        const idade = calcIdade(nascimento);
        const celular = p.celular ?? "";
        const posicao = (p.posicao ?? p.pos ?? "").toString();
        const hab = (p.hab ?? "").toString();
        const vel = (p.vel ?? "").toString();
        const mov = (p.mov ?? "").toString();
        const pontos = (p.pontos ?? "0").toString();

        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td class="center">${camisa}</td>
          <td>${apelido}</td>
          <td>${nome}</td>
          <td class="center">${nascimento}</td>
          <td class="center">${idade}</td>
          <td>${celular}</td>
          <td class="center">${posicao}</td>
          <td class="center">${hab}</td>
          <td class="center">${vel}</td>
          <td class="center">${mov}</td>
          <td class="center">${pontos}</td>
          <td class="center"><button class="btn-mini btn-edit" data-edit="${encodeURIComponent(apelido)}">EDITAR</button></td>
          <td class="center"><button class="btn-mini btn-del" data-del="${encodeURIComponent(apelido)}">EXCLUIR</button></td>
        `;
        tbody.appendChild(tr);

        // guarda ID se existir
        tr.dataset.id = (id !== null && id !== undefined) ? String(id) : "";
        tr.dataset.apelido = apelido;
      });

      // ações
      tbody.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ap = decodeURIComponent(btn.getAttribute("data-edit"));
          const row = [...tbody.querySelectorAll("tr")].find(r => (r.dataset.apelido||"") === ap);
          if(!row) return;
          // preenche form pelo texto da linha (simples e estável)
          const tds = row.querySelectorAll("td");
          document.getElementById("camisa").value = tds[1].textContent.trim();
          document.getElementById("apelido").value = tds[2].textContent.trim();
          document.getElementById("nome").value = tds[3].textContent.trim();
          document.getElementById("nascimento").value = tds[4].textContent.trim();
          document.getElementById("celular").value = tds[6].textContent.trim();
          document.getElementById("posicao").value = (tds[7].textContent.trim() || "").toUpperCase();
          document.getElementById("hab").value = tds[8].textContent.trim();
          document.getElementById("vel").value = tds[9].textContent.trim();
          document.getElementById("mov").value = tds[10].textContent.trim();
          document.getElementById("pontos").value = tds[11].textContent.trim() || "0";
          setStatusOk("Editando: " + ap);
          // marca edição pelo apelido (mais compatível)
          document.getElementById("btnSalvar").dataset.edit = ap;
        });
      });

      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const ap = decodeURIComponent(btn.getAttribute("data-del"));
          if(!confirm("Excluir jogador: " + ap + " ?")) return;
          try{
            setStatusOk("Excluindo...");
            // tenta por apelido
            const res = await apiFetch("/" + encodeURIComponent(ap), { method:"DELETE" });
            if(!res.ok){
              const txt = await res.text().catch(()=> "");
              throw new Error("Falha ao excluir: " + res.status + " " + txt);
            }
            await loadList();
            setStatusOk("Excluído: " + ap);
          }catch(e){
            setStatusErr(String(e.message||e));
          }
        });
      });
    }

    function renderBdays(lista){
      const now = new Date();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();

      const itens = (lista||[])
        .map(p=>{
          const apelido = (p.apelido||"").toString();
          const nascimento = (p.nascimento ?? p.nasc ?? p.data_nasc ?? "").toString();
          if(!nascimento || nascimento.length < 10) return null;
          const [y,m,d] = nascimento.split("-").map(Number);
          if(!m || !d) return null;
          if(m !== month) return null;
          const idade = calcIdade(nascimento);
          return { apelido, dia: String(d).padStart(2,"0"), idade };
        })
        .filter(Boolean)
        .sort((a,b)=> Number(a.dia)-Number(b.dia));

      const title = document.getElementById("bdayTitle");
      const months = ["JANEIRO","FEVEREIRO","MARÇO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"];
      title.textContent = `ANIVERSARIANTES DO MÊS - ${months[month-1]} / ${year}`;

      const box = document.getElementById("bdayContent");
      if(!itens.length){
        box.innerHTML = `<div style="color:#9bb0d1;font-weight:900">Nenhum aniversariante neste mês.</div>`;
        return;
      }

      let html = `
        <table class="bday-table">
          <thead>
            <tr><th>APELIDO</th><th>DIA</th><th>IDADE</th></tr>
          </thead>
          <tbody>
      `;
      itens.forEach(x=>{
        html += `<tr><td>${x.apelido}</td><td>${x.dia}</td><td>${x.idade}</td></tr>`;
      });
      html += `</tbody></table>`;
      box.innerHTML = html;
    }

    // ===== SALVAR (cria/edita e sempre recarrega TOTAL) =====
    async function salvar(){
      try{
        const f = getForm();

        if(!f.apelido){
          setStatusErr("ERRO: informe o APELIDO");
          return;
        }

        // valida posição (sem goleiro)
        if(f.posicao && !["Z","L","M","A"].includes(f.posicao)){
          setStatusErr("ERRO: POSIÇÃO inválida (use Z/L/M/A)");
          return;
        }

        setStatusOk("Salvando...");

        const editApelido = (document.getElementById("btnSalvar").dataset.edit || "").trim();

        const payload = {
          camisa: f.camisa,
          apelido: f.apelido,
          nome: f.nome,
          nascimento: f.nascimento,
          celular: f.celular,
          posicao: f.posicao,
          hab: f.hab,
          vel: f.vel,
          mov: f.mov,
          pontos: f.pontos
        };

        let res;
        if(editApelido){
          // update
          res = await apiFetch("/" + encodeURIComponent(editApelido), {
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        }else{
          // create
          res = await apiFetch("", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        }

        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          // Mostra erro real (ex: apelido duplicado)
          throw new Error("Falha ao salvar: " + res.status + " " + txt);
        }

        // sempre recarrega lista pra atualizar TOTAL
        await loadList();

        // limpa modo edição
        document.getElementById("btnSalvar").dataset.edit = "";
        clearForm();
        document.getElementById("pontos").value = "0";

        setStatusOk("OK: salvo e lista atualizada");
      }catch(e){
        setStatusErr(String(e.message||e));
      }
    }

    // ===== INIT =====
    document.getElementById("btnSalvar").addEventListener("click", salvar);
    document.getElementById("btnLimpar").addEventListener("click", ()=>{
      document.getElementById("btnSalvar").dataset.edit = "";
      clearForm();
      document.getElementById("pontos").value = "0";
      setStatusOk("OK: limpo");
    });
    document.getElementById("btnPdf").addEventListener("click", ()=> window.print());

    // força POSIÇÃO 1 letra maiúscula
    document.getElementById("posicao").addEventListener("input", (e)=>{
      e.target.value = (e.target.value || "").toUpperCase().slice(0,1);
    });

    // carrega
    (async ()=>{
      try{
        await loadList();
      }catch(e){
        setStatusErr(String(e.message||e));
      }
    })();
  </script>
</body>
</html>
