<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA - JOGADORES</title>

  <style>
    :root{
      --bg:#061226;
      --card:#0b1932;
      --line:#243552;
      --txt:#e6eefc;
      --muted:#9bb0d1;
      --orange:#f28c28;
      --green:#22c55e;
      --blue:#22a3ff;
      --red:#ff3b3b;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #0b1b3a 0%, var(--bg) 55%, #040b18 100%);
      color:var(--txt);
    }

    .container{ max-width: 1180px; margin: 18px auto 30px; padding: 0 14px; }
    h1{ margin:0 0 10px; font-size:22px; letter-spacing:.4px; color:var(--orange); }

    .rev{
      color:var(--green);
      font-weight:900;
      margin: 6px 0 12px;
      font-size: 13px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    /* Barra de ajuda */
    .helpbar{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom: 12px;
      color: #cfe0ff;
      font-weight: 800;
      font-size: 12px;
    }

    /* ===== FORM (usando seu esquema de larguras) ===== */
    .form-grid{
      display:grid;
      grid-template-columns: 70px 220px 140px 110px; /* Camisa, Nome, Apelido, Data Nasc */
      gap: 10px 12px;
      align-items:end;
    }

    .field label{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color:#cfe0ff;
      margin: 0 0 6px;
      letter-spacing:.2px;
    }

    input{
      width:100%;
      height: 34px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
    }
    input::placeholder{ color: rgba(230,238,252,.45); font-weight:700; }

    .row2{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 140px 60px 60px 60px; /* Celular, Posição, Hab, Vel */
      gap: 10px 12px;
      align-items:end;
    }

    .row3{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 60px 60px 1fr; /* Mov, Pontos, Botões */
      gap: 10px 12px;
      align-items:end;
    }

    .btns{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    .btn{
      height: 36px;
      min-width: 110px;
      padding: 0 14px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .btn-save{ background: var(--green); color:#05210f; }
    .btn-clear{ background: var(--orange); color:#2a1200; }
    .btn-pdf{ background: var(--blue); color:#001a2a; }

    .status{
      margin: 10px 2px 0;
      font-weight: 900;
      font-size: 12px;
    }
    .status.ok{ color: var(--green); }
    .status.err{ color: var(--red); }

    .total{
      margin: 4px 2px 0;
      font-weight: 900;
      font-size: 12px;
      color: #ffffff;
    }

    /* ===== ANIVERSARIANTES (larguras fixas: 100 / 60 / 60) ===== */
    .bday-card{
      margin-top: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px 12px;
    }
    .bday-title{
      color: var(--orange);
      font-weight: 900;
      margin: 0 0 10px;
      font-size: 13px;
      letter-spacing:.25px;
    }

    .bday-table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      overflow:hidden;
      border-radius: 12px;
    }
    .bday-table th, .bday-table td{
      border: 1px solid rgba(255,255,255,.10);
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
    }
    .bday-table th{
      color: var(--orange);
      background: rgba(0,0,0,.20);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing:.4px;
    }
    .bday-table th:nth-child(1), .bday-table td:nth-child(1){ width: 100px; }
    .bday-table th:nth-child(2), .bday-table td:nth-child(2){ width: 60px; text-align:center; }
    .bday-table th:nth-child(3), .bday-table td:nth-child(3){ width: 60px; text-align:center; }

    /* ===== TABELA PRINCIPAL (larguras do seu esquema) ===== */
    .table-wrap{
      margin-top: 14px;
      border-radius: 14px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      max-height: 520px;
    }

    table.main{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 1180px;
    }

    table.main th, table.main td{
      border: 1px solid rgba(255,255,255,.10);
      padding: 8px 8px;
      font-size: 12px;
      font-weight: 900;
      color: var(--txt);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    table.main th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(0,0,0,.28);
      color: var(--orange);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .45px;
    }

    .center{ text-align:center; }
    .btn-mini{
      height: 30px;
      min-width: 110px;
      padding: 0 12px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .btn-edit{ background: #22a3ff; color:#001a2a; }
    .btn-del{ background: #ff3b3b; color:#2a0000; }

    /* Print */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .container{ max-width:none; margin:0; padding:0; }
      .card{ box-shadow:none; border:1px solid #ddd; }
      table.main, .table-wrap{ max-height:none !important; overflow: visible !important; }
      *{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
    }
  
/* PATCH_JOGADORES_PRINT_v1 */
html, body { overflow-x: hidden !important; }

/* tenta eliminar a barra horizontal sem cortar tudo */
table { width: 100% !important; table-layout: fixed !important; }
th, td { padding: 6px 8px !important; font-size: 12px !important; }
th { white-space: nowrap !important; }

/* coluna NOME costuma estourar: permite quebrar linha */
td:nth-child(4), th:nth-child(4) { white-space: normal !important; }

/* ações menores (EDITAR/EXCLUIR) */
th:nth-child(13), td:nth-child(13),
th:nth-child(14), td:nth-child(14) { width: 84px !important; }

/* ===== PDF/PRINT legível ===== */
@media print{
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  html, body { background: #fff !important; color: #000 !important; }

  /* não imprimir campos e botões */
  input, button { display: none !important; }

  /* deixa tudo claro no PDF */
  .card, .box, .panel, .container, .wrap, .content {
    background: #fff !important;
    color: #000 !important;
    box-shadow: none !important;
  }

  table { font-size: 11px !important; }
  th { background: #eee !important; color: #000 !important; }
  td, th { border: 1px solid #333 !important; }
}


/* ===== FIXES (PDF + SEM BARRA HORIZONTAL) ===== */
html, body{ overflow-x:hidden !important; }
*, *:before, *:after{ box-sizing:border-box; }

/* força tabelas caberem na tela */
table{ width:100% !important; max-width:100% !important; table-layout:fixed; }
th, td{ padding:6px 6px !important; font-size:12px !important; }
td{ word-break:break-word; }

/* mata qualquer wrapper que esteja criando scroll horizontal */
[class*="table"], [class*="tabela"], [class*="grid"], [class*="lista"], [class*="wrap"]{
  max-width:100% !important;
}

/* modo PDF */
.pdf-mode, .pdf-mode body{ background:#fff !important; }
.pdf-mode *{ color:#000 !important; background:transparent !important; }
.pdf-mode table{ border-collapse:collapse !important; }
.pdf-mode th, .pdf-mode td{ border:1px solid #444 !important; }

@media print{
  @page{ size: A4 landscape; margin: 10mm; }
  html, body{ background:#fff !important; }
  *{ color:#000 !important; background:transparent !important; }
  table{ table-layout:fixed !important; width:100% !important; }
}


html, body{ overflow-x:hidden !important; }
*{ box-sizing:border-box; }
div{ overflow-x:hidden !important; }

table{ width:100% !important; max-width:100% !important; table-layout:fixed !important; }
th, td{
  white-space:normal !important;
  word-break:break-word !important;
  overflow-wrap:anywhere !important;
  padding:5px 6px !important;
  font-size:12px !important;
}
.tbl-main th, .tbl-main td{ font-size:11px !important; padding:4px 5px !important; }

.tbl-main th:nth-child(1), .tbl-main td:nth-child(1){ width:52px !important; }  /* ORDEM */
.tbl-main th:nth-child(2), .tbl-main td:nth-child(2){ width:58px !important; }  /* CAMISA */
.tbl-main th:nth-child(3), .tbl-main td:nth-child(3){ width:95px !important; }  /* APELIDO */
.tbl-main th:nth-child(4), .tbl-main td:nth-child(4){ width:170px !important; } /* NOME */
.tbl-main th:nth-child(5), .tbl-main td:nth-child(5){ width:92px !important; }  /* DATA */
.tbl-main th:nth-child(6), .tbl-main td:nth-child(6){ width:55px !important; }  /* IDADE */
.tbl-main th:nth-child(7), .tbl-main td:nth-child(7){ width:120px !important; } /* CELULAR */
.tbl-main th:nth-child(8), .tbl-main td:nth-child(8){ width:55px !important; }  /* POS */
.tbl-main th:nth-child(9), .tbl-main td:nth-child(9){ width:45px !important; }  /* HAB */
.tbl-main th:nth-child(10), .tbl-main td:nth-child(10){ width:45px !important; }/* VEL */
.tbl-main th:nth-child(11), .tbl-main td:nth-child(11){ width:45px !important; }/* MOV */
.tbl-main th:nth-child(12), .tbl-main td:nth-child(12){ width:60px !important; }/* PONTOS */
.tbl-main th:nth-child(13), .tbl-main td:nth-child(13){ width:70px !important; }/* EDITAR */
.tbl-main th:nth-child(14), .tbl-main td:nth-child(14){ width:70px !important; }/* EXCLUIR */

@media print{
  @page{ size:A4 landscape; margin:10mm; }
  html, body{ background:#fff !important; }
}


/* ===== R3 FIX: AUMENTAR ÁREA VISÍVEL + SEM BARRA HORIZONTAL (SEM CORTAR) ===== */
:root{ --panelW: 1400px; }

/* NÃO cortar o painel */
html, body{ overflow-x: auto !important; }

/* aumentar a “caixa” principal do painel */
.container, .wrap, .page, .card, .panel, main{
  width: min(var(--panelW), 98vw) !important;
  max-width: min(var(--panelW), 98vw) !important;
  margin-left: auto !important;
  margin-right: auto !important;
}

/* tabela principal caber na tela (sem barra horizontal) */
table{ width:100% !important; max-width:100% !important; table-layout:fixed !important; }
th, td{
  white-space:normal !important;
  word-break:break-word !important;
  overflow-wrap:anywhere !important;
  padding:4px 5px !important;
  font-size:11px !important;
}

/* aplica só na tabela da lista (ORD...) */
.tbl-main th, .tbl-main td{ font-size:10.5px !important; padding:3px 4px !important; }

/* larguras para caber “ORDEM → EXCLUIR” */
.tbl-main th:nth-child(1),  .tbl-main td:nth-child(1){  width:52px !important; }  /* ORDEM */
.tbl-main th:nth-child(2),  .tbl-main td:nth-child(2){  width:58px !important; }  /* CAMISA */
.tbl-main th:nth-child(3),  .tbl-main td:nth-child(3){  width:95px !important; }  /* APELIDO */
.tbl-main th:nth-child(4),  .tbl-main td:nth-child(4){  width:170px !important; } /* NOME */
.tbl-main th:nth-child(5),  .tbl-main td:nth-child(5){  width:92px !important; }  /* DATA */
.tbl-main th:nth-child(6),  .tbl-main td:nth-child(6){  width:55px !important; }  /* IDADE */
.tbl-main th:nth-child(7),  .tbl-main td:nth-child(7){  width:120px !important; } /* CELULAR */
.tbl-main th:nth-child(8),  .tbl-main td:nth-child(8){  width:55px !important; }  /* POS */
.tbl-main th:nth-child(9),  .tbl-main td:nth-child(9){  width:45px !important; }  /* HAB */
.tbl-main th:nth-child(10), .tbl-main td:nth-child(10){ width:45px !important; }  /* VEL */
.tbl-main th:nth-child(11), .tbl-main td:nth-child(11){ width:45px !important; }  /* MOV */
.tbl-main th:nth-child(12), .tbl-main td:nth-child(12){ width:60px !important; }  /* PONTOS */
.tbl-main th:nth-child(13), .tbl-main td:nth-child(13){ width:70px !important; }  /* EDITAR */
.tbl-main th:nth-child(14), .tbl-main td:nth-child(14){ width:70px !important; }  /* EXCLUIR */

@media print{
  @page{ size:A4 landscape; margin:10mm; }
  html, body{ background:#fff !important; }
}


    /* ===== FIX ETAPA 1 (CABECALHO + LARGURAS) ===== */
    .container{max-width:1600px !important; width:96vw !important;}
    .tbl-main{table-layout:fixed !important; width:100% !important;}
    .tbl-main thead th{
      background:#f97316 !important;
      color:#0b1120 !important;
      opacity:1 !important;
      position:sticky !important;
      top:0 !important;
      z-index:50 !important;
      white-space:nowrap !important;
    }
    .tbl-main th, .tbl-main td{white-space:nowrap !important;}
    .tbl-main th:nth-child(8), .tbl-main td:nth-child(8){min-width:90px !important;}


/* REV JOGADORES LAYOUT ETAPA 4 - 2026-01-21 */
/* 1) deixar painel mais largo */
.container, .wrap, .page, main{
  max-width: 1750px !important;
  width: calc(100vw - 80px) !important;
}

/* 2) cabeçalho da tabela: mesma “altura” das linhas + letra maior */
#tbl thead th{
  font-size: 14px !important;
  font-weight: 800 !important;
  padding: 10px 10px !important;
  line-height: 1.1 !important;
  white-space: nowrap !important;
}
#tbl tbody td{
  padding: 10px 10px !important;
  line-height: 1.1 !important;
}

/* coluna POSIÇÃO mais larga (evita quebrar) */
#tbl th:nth-child(8), #tbl td:nth-child(8){
  width: 90px !important;
}

/* 3) caixas de edição todas na mesma linha */
.form-one-line{
  display: grid !important;
  grid-template-columns:
    70px   /* CAMISA */
    220px  /* NOME */
    140px  /* APELIDO */
    110px  /* NASCIMENTO */
    140px  /* CELULAR */
    80px   /* POSIÇÃO */
    60px   /* HAB */
    60px   /* VEL */
    60px   /* MOV */
    60px;  /* PONTOS */
  gap: 12px !important;
  align-items: end !important;
  width: 100% !important;
  overflow-x: auto !important;
  padding-bottom: 6px !important;
}

.form-one-line .field label{
  font-size: 12px !important;
  font-weight: 800 !important;
  letter-spacing: .5px !important;
  margin-bottom: 6px !important;
  white-space: nowrap !important;
}

.form-one-line .field input{
  height: 38px !important;
}

/* 4) barra abaixo das caixas: esquerda (status/total) e direita (botões) */
.actions-bar{
  display: flex !important;
  align-items: flex-end !important;
  justify-content: space-between !important;
  gap: 16px !important;
  margin-top: 10px !important;
}

.actions-bar .msgs{
  display: flex !important;
  flex-direction: column !important;
  gap: 6px !important;
  min-width: 320px !important;
}

.actions-bar .btns{
  display: flex !important;
  gap: 14px !important;
  justify-content: flex-end !important;
}

/* 5) aniversariantes menor */
#bdayBox{
  max-width: 820px !important;
  padding: 10px 12px !important;
}
#bdayTitle{
  font-size: 14px !important;
  font-weight: 900 !important;
}
#bdayBox table, #bdayBox td, #bdayBox th{
  font-size: 12px !important;
  padding: 6px 8px !important;
}
/* END REV JOGADORES LAYOUT ETAPA 4 */


/* REV JOGADORES LAYOUT ETAPA 5 - 2026-01-21 */
/* Aniversariantes com colunas fixas (px) conforme esquema */
#bdayBox{
  max-width: 360px !important;
  width: 360px !important;
}
#bdayContent{
  display: flex !important;
  justify-content: center !important;
}
#bdayBox table{
  width: auto !important;
  max-width: 320px !important;
  border-collapse: collapse !important;
}
#bdayBox th, #bdayBox td{
  font-size: 12px !important;
  padding: 6px 8px !important;
  white-space: nowrap !important;
}
/* APELIDO=100px, DATA=60px, IDADE=60px */
#bdayBox th:nth-child(1), #bdayBox td:nth-child(1){ width:100px !important; }
#bdayBox th:nth-child(2), #bdayBox td:nth-child(2){ width:60px !important; text-align:center !important; }
#bdayBox th:nth-child(3), #bdayBox td:nth-child(3){ width:60px !important; text-align:center !important; }
/* END REV JOGADORES LAYOUT ETAPA 5 */

</style>
  <script src="./html2pdf.bundle.min.js"></script>
<script>
  // Helpers (defensivos)
  async function apiGetJson(url) {
    const resp = await fetch(url, { cache: "no-store" });
    const text = await resp.text();
    let data = null;
    try { data = JSON.parse(text); } catch (_) {}
    if (!resp.ok) {
      const msg = data?.error ? String(data.error) : (text || `HTTP ${resp.status}`);
      throw new Error(msg);
    }
    return data;
  }
  function byId(id){ return document.getElementById(id); }
  function ymdToBr(ymd){
    if(!ymd) return "";
    const m = String(ymd).match(/(\d{4})[-\/](\d{2})[-\/](\d{2})/);
    if(!m) return String(ymd);
    return `${m[3]}/${m[2]}/${m[1]}`;
  }
  function calcIdade(ymd){
    const m = String(ymd||"").match(/(\d{4})-(\d{2})-(\d{2})/);
    if(!m) return "";
    const y=+m[1], mo=+m[2]-1, d=+m[3];
    const dob=new Date(y,mo,d);
    const now=new Date();
    let age = now.getFullYear()-dob.getFullYear();
    const md = now.getMonth()-dob.getMonth();
    if(md<0 || (md===0 && now.getDate()<dob.getDate())) age--;
    return String(age);
  }
</script>
</head>

<body>
  <div class="container">
    <h1>TESOURA - JOGADORES</h1>

    <div class="rev">REV JOGADORES: 16/01 11:25</div>

    <div class="card">
      <div class="no-print">
        <div class="helpbar">
          <span>POSIÇÃO (Z/L/M/A): ZAGUEIRO / LATERAL / MEIO / ATAQUE</span>
          <span>HABILIDADE (1–5)</span>
          <span>VELOCIDADE (1–L, 2–N, 3–I)</span>
          <span>MOVIMENTAÇÃO (1–P, 2–N, 3–I)</span>
        </div>

        <!-- FORM -->
          <div class="form-one-line">
            <div class="field">
              <label>CAMISA</label>
              <input id="camisa" placeholder="N°" inputmode="numeric" />
            </div>

            <div class="field">
              <label>NOME</label>
              <input id="nome" placeholder="Nome completo" />
            </div>

            <div class="field">
              <label>APELIDO (ÚNICO)*</label>
              <input id="apelido" placeholder="Apelido" />
            </div>

            <div class="field">
              <label>NASCIMENTO</label>
              <input id="nascimento" placeholder="AAAA-MM-DD" />
            </div>

            <div class="field">
              <label>CELULAR</label>
              <input id="celular" placeholder="DDD + número" />
            </div>

            <div class="field">
              <label>POSIÇÃO</label>
              <input id="posicao" placeholder="Z/L/M/A" maxlength="1" />
            </div>

            <div class="field">
              <label>HAB</label>
              <input id="hab" placeholder="1-5" inputmode="numeric" />
            </div>

            <div class="field">
              <label>VEL</label>
              <input id="vel" placeholder="1-3" inputmode="numeric" />
            </div>

            <div class="field">
              <label>MOV</label>
              <input id="mov" placeholder="1-3" inputmode="numeric" />
            </div>

            <div class="field">
              <label>PONTOS</label>
              <input id="pontos" placeholder="0" inputmode="numeric" />
            </div>
          </div>

          <div class="actions-bar">
            <div class="msgs">
              <div id="status" class="status ok">OK: lista carregada</div>
              <div class="total" id="total">TOTAL DE JOGADORES: 0</div>
            </div>

            <div class="btns">
              <button class="btn btn-save" id="btnSalvar">SALVAR</button>
              <button class="btn btn-clear" id="btnLimpar">LIMPAR</button>
              <button class="btn btn-pdf" id="btnPdf">BAIXAR PDF</button>
            </div>
          </div>

        </div>

        <!-- ANIVERSARIANTES -->
      <div class="bday-card" id="bdayBox">
        <div class="bday-title" id="bdayTitle">ANIVERSARIANTES DO MÊS</div>
        <div id="bdayContent">Carregando...</div>
      </div>

      <!-- TABELA -->
      <div class="table-wrap">
        <table class="main" id="tbl">
          <colgroup>
            <col style="width:60px" />
            <col style="width:70px" />
            <col style="width:140px" />
            <col style="width:220px" />
            <col style="width:110px" />
            <col style="width:70px" />
            <col style="width:140px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:110px" />
            <col style="width:110px" />
          </colgroup>
          <thead>
            <tr>
              <th class="center">ORDEM</th>
              <th class="center">CAMISA</th>
              <th>APELIDO</th>
              <th>NOME</th>
              <th class="center">DATA NASC.</th>
              <th class="center">IDADE</th>
              <th>CELULAR</th>
              <th class="center">POSIÇÃO</th>
              <th class="center">HAB</th>
              <th class="center">VEL</th>
              <th class="center">MOV</th>
              <th class="center">PONTOS</th>
              <th class="center">EDITAR</th>
              <th class="center">EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
// =====================
// TESOURA - JOGADORES (FIX)
// =====================
let EDIT_APELIDO = null;

function $(id){ return document.getElementById(id); }

function showStatus(msg, ok=true){
  const el = $("status");
  if (!el) return;
  el.textContent = msg;
  el.style.color = ok ? "#00d38a" : "#ff5c5c";
}

function clearForm(){
  EDIT_APELIDO = null;
  ["camisa","nome","apelido","nascimento","celular"].forEach(id => { if($(id)) $(id).value=""; });
  ["posicao","hab","vel","mov","pontos"].forEach(id => { if($(id)) $(id).value=""; });
}

function getFormData(){
  return {
    camisa: ($("camisa")?.value || "").trim(),
    nome: ($("nome")?.value || "").trim(),
    apelido: ($("apelido")?.value || "").trim(),
    nascimento: ($("nascimento")?.value || "").trim(),
    celular: ($("celular")?.value || "").trim(),
    posicao: ($("posicao")?.value || "").trim(),
    hab: Number($("hab")?.value || 0),
    vel: Number($("vel")?.value || 0),
    mov: Number($("mov")?.value || 0),
    pontos: Number($("pontos")?.value || 0),
  };
}

function renderAniversariantes(lista){
  const box = $("aniversariantes");
  if (!box) return;
  const mes = new Date().getMonth() + 1;
  const anivs = lista.filter(j => String(j.nascimento||"").match(/^\d{4}-(\d{2})-\d{2}$/) && Number(RegExp.$1) === mes);
  box.textContent = anivs.length ? anivs.map(j => `${j.apelido} (${ymdToBr(j.nascimento)})`).join(" • ") : "Nenhum aniversariante neste mês.";
}

function renderTabela(lista){
  const tbody = $("tbody");
  if (!tbody) return;
  tbody.innerHTML = "";
  lista.forEach((j, idx) => {
    const nascimento = j.nascimento || "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${j.ordem ?? (idx+1)}</td>
      <td>${j.camisa ?? ""}</td>
      <td style="color:#fff;font-weight:700">${j.apelido ?? ""}</td>
      <td>${j.nome ?? ""}</td>
      <td>${ymdToBr(nascimento)}</td>
      <td>${calcIdade(nascimento)}</td>
      <td>${j.celular ?? ""}</td>
      <td>${j.posicao ?? ""}</td>
      <td>${j.hab ?? ""}</td>
      <td>${j.vel ?? ""}</td>
      <td>${j.mov ?? ""}</td>
      <td>${j.pontos ?? 0}</td>
      <td><button class="btn-edit" data-apelido="${encodeURIComponent(j.apelido||"")}">EDITAR</button></td>
      <td><button class="btn-del" data-apelido="${encodeURIComponent(j.apelido||"")}">EXCLUIR</button></td>
    `;
    tbody.appendChild(tr);
  });
  const total = $("total");
  if (total) total.textContent = String(lista.length);
}

async function loadList(){
  try{
    const data = await apiGetJson("/api/jogadores");
    const lista = Array.isArray(data?.jogadores) ? data.jogadores : [];
    renderTabela(lista);
    renderAniversariantes(lista);
    showStatus("OK: lista carregada", true);
  }catch(err){
    showStatus("ERRO ao carregar lista", false);
    alert("Falha ao carregar jogadores: " + (err?.message || err));
  }
}

async function onSave(){
  const payload = getFormData();
  if (!payload.apelido){
    alert("Preencha o APELIDO.");
    return;
  }
  try{
    if (EDIT_APELIDO){
      // Atualiza pelo apelido original
      const resp = await fetch(`/api/jogadores/${encodeURIComponent(EDIT_APELIDO)}`, {
        method: "PUT",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
      });
      const tx = await resp.text();
      if (!resp.ok) throw new Error(tx);
    } else {
      const resp = await fetch("/api/jogadores", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload),
      });
      const tx = await resp.text();
      if (!resp.ok) throw new Error(tx);
    }
    clearForm();
    await loadList();
  }catch(err){
    alert("Erro ao salvar: " + (err?.message || err));
  }
}

async function onDelete(apelido){
  if (!apelido) return;
  if (!confirm(`Excluir ${apelido}?`)) return;
  try{
    const resp = await fetch(`/api/jogadores/${encodeURIComponent(apelido)}`, { method: "DELETE" });
    const tx = await resp.text();
    if (!resp.ok) throw new Error(tx);
    await loadList();
  }catch(err){
    alert("Erro ao excluir: " + (err?.message || err));
  }
}

function onEditFromRow(row){
  EDIT_APELIDO = row.apelido;
  $("camisa") && ($("camisa").value = row.camisa ?? "");
  $("nome") && ($("nome").value = row.nome ?? "");
  $("apelido") && ($("apelido").value = row.apelido ?? "");
  $("nascimento") && ($("nascimento").value = row.nascimento ?? "");
  $("celular") && ($("celular").value = row.celular ?? "");
  $("posicao") && ($("posicao").value = row.posicao ?? "");
  $("hab") && ($("hab").value = row.hab ?? "");
  $("vel") && ($("vel").value = row.vel ?? "");
  $("mov") && ($("mov").value = row.mov ?? "");
  $("pontos") && ($("pontos").value = row.pontos ?? 0);
  showStatus("Editando: " + (row.apelido||""), true);
}

// Delegação de cliques na tabela
function bindTableActions(){
  const table = $("tbl");
  if (!table || table.__bound) return;
  table.__bound = true;

  table.addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!(t instanceof HTMLElement)) return;
    if (t.classList.contains("btn-del")){
      const apelido = decodeURIComponent(t.getAttribute("data-apelido")||"");
      await onDelete(apelido);
    }
    if (t.classList.contains("btn-edit")){
      const apelido = decodeURIComponent(t.getAttribute("data-apelido")||"");
      // pega a linha atual da tabela já renderizada
      // (recarrega lista e acha pelo apelido)
      try{
        const data = await apiGetJson("/api/jogadores");
        const lista = Array.isArray(data?.jogadores) ? data.jogadores : [];
        const row = lista.find(x => String(x.apelido) === String(apelido));
        if (row) onEditFromRow(row);
      }catch(_){}
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  // binds (defensivo)
  $("btnSalvar")?.addEventListener("click", onSave);
  $("btnLimpar")?.addEventListener("click", () => { clearForm(); showStatus("Form limpo", true); });
  $("btnPdf")?.addEventListener("click", () => { window.print(); });

  bindTableActions();
  loadList();
});
</script>
</body>
</html>
