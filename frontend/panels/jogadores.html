<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA - JOGADORES</title>

  <style>
    :root{
      --bg:#061226;
      --card:#0b1932;
      --line:#243552;
      --txt:#e6eefc;
      --muted:#9bb0d1;
      --orange:#f28c28;
      --green:#22c55e;
      --blue:#22a3ff;
      --red:#ff3b3b;
      --shadow: 0 10px 28px rgba(0,0,0,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: radial-gradient(1200px 700px at 50% 0%, #0b1b3a 0%, var(--bg) 55%, #040b18 100%);
      color:var(--txt);
    }

    .container{ max-width: 1180px; margin: 18px auto 30px; padding: 0 14px; }
    h1{ margin:0 0 10px; font-size:22px; letter-spacing:.4px; color:var(--orange); }

    .rev{
      color:var(--green);
      font-weight:900;
      margin: 6px 0 12px;
      font-size: 13px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    /* Barra de ajuda */
    .helpbar{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      margin-bottom: 12px;
      color: #cfe0ff;
      font-weight: 800;
      font-size: 12px;
    }

    /* ===== FORM (usando seu esquema de larguras) ===== */
    .form-grid{
      display:grid;
      grid-template-columns: 70px 220px 140px 110px; /* Camisa, Nome, Apelido, Data Nasc */
      gap: 10px 12px;
      align-items:end;
    }

    .field label{
      display:block;
      font-size: 11px;
      font-weight: 900;
      color:#cfe0ff;
      margin: 0 0 6px;
      letter-spacing:.2px;
    }

    input{
      width:100%;
      height: 34px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline: none;
    }
    input::placeholder{ color: rgba(230,238,252,.45); font-weight:700; }

    .row2{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 140px 60px 60px 60px; /* Celular, Posição, Hab, Vel */
      gap: 10px 12px;
      align-items:end;
    }

    .row3{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 60px 60px 1fr; /* Mov, Pontos, Botões */
      gap: 10px 12px;
      align-items:end;
    }

    .btns{
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap:wrap;
    }

    .btn{
      height: 36px;
      min-width: 110px;
      padding: 0 14px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .btn-save{ background: var(--green); color:#05210f; }
    .btn-clear{ background: var(--orange); color:#2a1200; }
    .btn-pdf{ background: var(--blue); color:#001a2a; }

    .status{
      margin: 10px 2px 0;
      font-weight: 900;
      font-size: 12px;
    }
    .status.ok{ color: var(--green); }
    .status.err{ color: var(--red); }

    .total{
      margin: 4px 2px 0;
      font-weight: 900;
      font-size: 12px;
      color: #ffffff;
    }

    /* ===== ANIVERSARIANTES (larguras fixas: 100 / 60 / 60) ===== */
    .bday-card{
      margin-top: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px 12px;
    }
    .bday-title{
      color: var(--orange);
      font-weight: 900;
      margin: 0 0 10px;
      font-size: 13px;
      letter-spacing:.25px;
    }

    .bday-table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;
      overflow:hidden;
      border-radius: 12px;
    }
    .bday-table th, .bday-table td{
      border: 1px solid rgba(255,255,255,.10);
      padding: 8px 10px;
      font-weight: 900;
      font-size: 12px;
    }
    .bday-table th{
      color: var(--orange);
      background: rgba(0,0,0,.20);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing:.4px;
    }
    .bday-table th:nth-child(1), .bday-table td:nth-child(1){ width: 100px; }
    .bday-table th:nth-child(2), .bday-table td:nth-child(2){ width: 60px; text-align:center; }
    .bday-table th:nth-child(3), .bday-table td:nth-child(3){ width: 60px; text-align:center; }

    /* ===== TABELA PRINCIPAL (larguras do seu esquema) ===== */
    .table-wrap{
      margin-top: 14px;
      border-radius: 14px;
      overflow: auto;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      max-height: 520px;
    }

    table.main{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 1180px;
    }

    table.main th, table.main td{
      border: 1px solid rgba(255,255,255,.10);
      padding: 8px 8px;
      font-size: 12px;
      font-weight: 900;
      color: var(--txt);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    table.main th{
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(0,0,0,.28);
      color: var(--orange);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: .45px;
    }

    .center{ text-align:center; }
    .btn-mini{
      height: 30px;
      min-width: 110px;
      padding: 0 12px;
      border-radius: 10px;
      border: 0;
      cursor:pointer;
      font-weight: 900;
      font-size: 12px;
    }
    .btn-edit{ background: #22a3ff; color:#001a2a; }
    .btn-del{ background: #ff3b3b; color:#2a0000; }

    /* Print */
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .container{ max-width:none; margin:0; padding:0; }
      .card{ box-shadow:none; border:1px solid #ddd; }
      table.main, .table-wrap{ max-height:none !important; overflow: visible !important; }
      *{-webkit-print-color-adjust:exact; print-color-adjust:exact;}
    }
  
/* PATCH_JOGADORES_PRINT_v1 */
html, body { overflow-x: hidden !important; }

/* tenta eliminar a barra horizontal sem cortar tudo */
table { width: 100% !important; table-layout: fixed !important; }
th, td { padding: 6px 8px !important; font-size: 12px !important; }
th { white-space: nowrap !important; }

/* coluna NOME costuma estourar: permite quebrar linha */
td:nth-child(4), th:nth-child(4) { white-space: normal !important; }

/* ações menores (EDITAR/EXCLUIR) */
th:nth-child(13), td:nth-child(13),
th:nth-child(14), td:nth-child(14) { width: 84px !important; }

/* ===== PDF/PRINT legível ===== */
@media print{
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
  html, body { background: #fff !important; color: #000 !important; }

  /* não imprimir campos e botões */
  input, button { display: none !important; }

  /* deixa tudo claro no PDF */
  .card, .box, .panel, .container, .wrap, .content {
    background: #fff !important;
    color: #000 !important;
    box-shadow: none !important;
  }

  table { font-size: 11px !important; }
  th { background: #eee !important; color: #000 !important; }
  td, th { border: 1px solid #333 !important; }
}


/* ===== FIXES (PDF + SEM BARRA HORIZONTAL) ===== */
html, body{ overflow-x:hidden !important; }
*, *:before, *:after{ box-sizing:border-box; }

/* força tabelas caberem na tela */
table{ width:100% !important; max-width:100% !important; table-layout:fixed; }
th, td{ padding:6px 6px !important; font-size:12px !important; }
td{ word-break:break-word; }

/* mata qualquer wrapper que esteja criando scroll horizontal */
[class*="table"], [class*="tabela"], [class*="grid"], [class*="lista"], [class*="wrap"]{
  max-width:100% !important;
}

/* modo PDF */
.pdf-mode, .pdf-mode body{ background:#fff !important; }
.pdf-mode *{ color:#000 !important; background:transparent !important; }
.pdf-mode table{ border-collapse:collapse !important; }
.pdf-mode th, .pdf-mode td{ border:1px solid #444 !important; }

@media print{
  @page{ size: A4 landscape; margin: 10mm; }
  html, body{ background:#fff !important; }
  *{ color:#000 !important; background:transparent !important; }
  table{ table-layout:fixed !important; width:100% !important; }
}


html, body{ overflow-x:hidden !important; }
*{ box-sizing:border-box; }
div{ overflow-x:hidden !important; }

table{ width:100% !important; max-width:100% !important; table-layout:fixed !important; }
th, td{
  white-space:normal !important;
  word-break:break-word !important;
  overflow-wrap:anywhere !important;
  padding:5px 6px !important;
  font-size:12px !important;
}
.tbl-main th, .tbl-main td{ font-size:11px !important; padding:4px 5px !important; }

.tbl-main th:nth-child(1), .tbl-main td:nth-child(1){ width:52px !important; }  /* ORDEM */
.tbl-main th:nth-child(2), .tbl-main td:nth-child(2){ width:58px !important; }  /* CAMISA */
.tbl-main th:nth-child(3), .tbl-main td:nth-child(3){ width:95px !important; }  /* APELIDO */
.tbl-main th:nth-child(4), .tbl-main td:nth-child(4){ width:170px !important; } /* NOME */
.tbl-main th:nth-child(5), .tbl-main td:nth-child(5){ width:92px !important; }  /* DATA */
.tbl-main th:nth-child(6), .tbl-main td:nth-child(6){ width:55px !important; }  /* IDADE */
.tbl-main th:nth-child(7), .tbl-main td:nth-child(7){ width:120px !important; } /* CELULAR */
.tbl-main th:nth-child(8), .tbl-main td:nth-child(8){ width:55px !important; }  /* POS */
.tbl-main th:nth-child(9), .tbl-main td:nth-child(9){ width:45px !important; }  /* HAB */
.tbl-main th:nth-child(10), .tbl-main td:nth-child(10){ width:45px !important; }/* VEL */
.tbl-main th:nth-child(11), .tbl-main td:nth-child(11){ width:45px !important; }/* MOV */
.tbl-main th:nth-child(12), .tbl-main td:nth-child(12){ width:60px !important; }/* PONTOS */
.tbl-main th:nth-child(13), .tbl-main td:nth-child(13){ width:70px !important; }/* EDITAR */
.tbl-main th:nth-child(14), .tbl-main td:nth-child(14){ width:70px !important; }/* EXCLUIR */

@media print{
  @page{ size:A4 landscape; margin:10mm; }
  html, body{ background:#fff !important; }
}


/* ===== R3 FIX: AUMENTAR ÁREA VISÍVEL + SEM BARRA HORIZONTAL (SEM CORTAR) ===== */
:root{ --panelW: 1400px; }

/* NÃO cortar o painel */
html, body{ overflow-x: auto !important; }

/* aumentar a “caixa” principal do painel */
.container, .wrap, .page, .card, .panel, main{
  width: min(var(--panelW), 98vw) !important;
  max-width: min(var(--panelW), 98vw) !important;
  margin-left: auto !important;
  margin-right: auto !important;
}

/* tabela principal caber na tela (sem barra horizontal) */
table{ width:100% !important; max-width:100% !important; table-layout:fixed !important; }
th, td{
  white-space:normal !important;
  word-break:break-word !important;
  overflow-wrap:anywhere !important;
  padding:4px 5px !important;
  font-size:11px !important;
}

/* aplica só na tabela da lista (ORD...) */
.tbl-main th, .tbl-main td{ font-size:10.5px !important; padding:3px 4px !important; }

/* larguras para caber “ORDEM → EXCLUIR” */
.tbl-main th:nth-child(1),  .tbl-main td:nth-child(1){  width:52px !important; }  /* ORDEM */
.tbl-main th:nth-child(2),  .tbl-main td:nth-child(2){  width:58px !important; }  /* CAMISA */
.tbl-main th:nth-child(3),  .tbl-main td:nth-child(3){  width:95px !important; }  /* APELIDO */
.tbl-main th:nth-child(4),  .tbl-main td:nth-child(4){  width:170px !important; } /* NOME */
.tbl-main th:nth-child(5),  .tbl-main td:nth-child(5){  width:92px !important; }  /* DATA */
.tbl-main th:nth-child(6),  .tbl-main td:nth-child(6){  width:55px !important; }  /* IDADE */
.tbl-main th:nth-child(7),  .tbl-main td:nth-child(7){  width:120px !important; } /* CELULAR */
.tbl-main th:nth-child(8),  .tbl-main td:nth-child(8){  width:55px !important; }  /* POS */
.tbl-main th:nth-child(9),  .tbl-main td:nth-child(9){  width:45px !important; }  /* HAB */
.tbl-main th:nth-child(10), .tbl-main td:nth-child(10){ width:45px !important; }  /* VEL */
.tbl-main th:nth-child(11), .tbl-main td:nth-child(11){ width:45px !important; }  /* MOV */
.tbl-main th:nth-child(12), .tbl-main td:nth-child(12){ width:60px !important; }  /* PONTOS */
.tbl-main th:nth-child(13), .tbl-main td:nth-child(13){ width:70px !important; }  /* EDITAR */
.tbl-main th:nth-child(14), .tbl-main td:nth-child(14){ width:70px !important; }  /* EXCLUIR */

@media print{
  @page{ size:A4 landscape; margin:10mm; }
  html, body{ background:#fff !important; }
}

</style>
  <script src="./html2pdf.bundle.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>TESOURA - JOGADORES</h1>

    <div class="rev">REV JOGADORES: 16/01 11:25</div>

    <div class="card">
      <div class="no-print">
        <div class="helpbar">
          <span>POSIÇÃO (Z/L/M/A): ZAGUEIRO / LATERAL / MEIO / ATAQUE</span>
          <span>HABILIDADE (1–5)</span>
          <span>VELOCIDADE (1–L, 2–N, 3–I)</span>
          <span>MOVIMENTAÇÃO (1–P, 2–N, 3–I)</span>
        </div>

        <!-- FORM -->
        <div class="form-grid">
          <div class="field">
            <label>CAMISA</label>
            <input id="camisa" placeholder="N°" inputmode="numeric" />
          </div>

          <div class="field">
            <label>NOME</label>
            <input id="nome" placeholder="Nome completo" />
          </div>

          <div class="field">
            <label>APELIDO (ÚNICO)*</label>
            <input id="apelido" placeholder="Apelido" />
          </div>

          <div class="field">
            <label>NASCIMENTO</label>
            <input id="nascimento" placeholder="AAAA-MM-DD" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>CELULAR</label>
            <input id="celular" placeholder="DDD + número" />
          </div>

          <div class="field">
            <label>POSIÇÃO (Z/L/M/A)</label>
            <!-- PEDIDO: SEM DROPDOWN, DIGITÁVEL -->
            <input id="posicao" placeholder="Z/L/M/A" maxlength="1" />
          </div>

          <div class="field">
            <label>HABILIDADE (1–5)</label>
            <input id="hab" placeholder="1-5" inputmode="numeric" />
          </div>

          <div class="field">
            <label>VELOCIDADE (1–3)</label>
            <input id="vel" placeholder="1-3" inputmode="numeric" />
          </div>
        </div>

        <div class="row3">
          <div class="field">
            <label>MOVIMENTAÇÃO (1–3)</label>
            <input id="mov" placeholder="1-3" inputmode="numeric" />
          </div>

          <div class="field">
            <label>PONTOS</label>
            <input id="pontos" placeholder="0" inputmode="numeric" />
          </div>

          <div class="btns">
            <button class="btn btn-save" id="btnSalvar">SALVAR</button>
            <button class="btn btn-clear" id="btnLimpar">LIMPAR</button>
            <button class="btn btn-pdf" id="btnPdf">BAIXAR PDF</button>
          </div>
        </div>

        <div id="status" class="status ok">OK: lista carregada</div>
        <div class="total" id="total">TOTAL DE JOGADORES: 0</div>
      </div>

      <!-- ANIVERSARIANTES -->
      <div class="bday-card" id="bdayBox">
        <div class="bday-title" id="bdayTitle">ANIVERSARIANTES DO MÊS</div>
        <div id="bdayContent">Carregando...</div>
      </div>

      <!-- TABELA -->
      <div class="table-wrap">
        <table class="main" id="tbl">
          <colgroup>
            <col style="width:60px" />
            <col style="width:70px" />
            <col style="width:140px" />
            <col style="width:220px" />
            <col style="width:110px" />
            <col style="width:70px" />
            <col style="width:140px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:60px" />
            <col style="width:110px" />
            <col style="width:110px" />
          </colgroup>
          <thead>
            <tr>
              <th class="center">ORDEM</th>
              <th class="center">CAMISA</th>
              <th>APELIDO</th>
              <th>NOME</th>
              <th class="center">DATA NASC.</th>
              <th class="center">IDADE</th>
              <th>CELULAR</th>
              <th class="center">POSIÇÃO</th>
              <th class="center">HAB</th>
              <th class="center">VEL</th>
              <th class="center">MOV</th>
              <th class="center">PONTOS</th>
              <th class="center">EDITAR</th>
              <th class="center">EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== API (tenta manter compatível) =====
    const API_BASES = [
      "/api/jogadores",
      "/api/jogadores/",
    ];

    function setStatusOk(msg){
      const el = document.getElementById("status");
      el.className = "status ok";
      el.textContent = msg;
    }
    function setStatusErr(msg){
      const el = document.getElementById("status");
      el.className = "status err";
      el.textContent = msg;
    }

    function onlyDigits(s){ return (s||"").replace(/\D+/g,""); }

    function calcIdade(yyyy_mm_dd){
      if(!yyyy_mm_dd || yyyy_mm_dd.length < 10) return "";
      const [y,m,d] = yyyy_mm_dd.split("-").map(Number);
      if(!y||!m||!d) return "";
      const birth = new Date(y, m-1, d);
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const mm = today.getMonth() - birth.getMonth();
      if (mm < 0 || (mm === 0 && today.getDate() < birth.getDate())) age--;
      return String(age);
    }

    async function apiFetch(path, opts={}){
      let lastErr = null;
      for(const base of API_BASES){
        try{
          const url = base.endsWith("/") ? (base + path.replace(/^\//,"")) : (base + path);
          const res = await fetch(url, opts);
          if(res.status === 404){
            lastErr = new Error("404 em " + url);
            continue;
          }
          return res;
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Falha na API");
    }

    async function loadList(){
      const res = await apiFetch("", { cache:"no-store" });
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        throw new Error("Erro ao carregar lista: " + res.status + " " + txt);
      }
      const data = await res.json();
      // aceita formatos comuns:
      // 1) {lista:[...]}
      // 2) [...]
      const lista = Array.isArray(data) ? data : (data.lista || data.jogadores || []);
      renderList(lista);
      renderBdays(lista);
      document.getElementById("total").textContent = "TOTAL DE JOGADORES: " + lista.length;
      setStatusOk("OK: lista carregada");
      return lista;
    }

    function normPos(v){
      v = (v||"").trim().toUpperCase();
      if(!v) return "";
      const one = v[0];
      return one;
    }

    function getForm(){
      const camisa = onlyDigits(document.getElementById("camisa").value.trim());
      const nome = document.getElementById("nome").value.trim();
      const apelido = document.getElementById("apelido").value.trim();
      const nascimento = document.getElementById("nascimento").value.trim();
      const celular = document.getElementById("celular").value.trim();
      const posicao = normPos(document.getElementById("posicao").value);
      const hab = onlyDigits(document.getElementById("hab").value.trim());
      const vel = onlyDigits(document.getElementById("vel").value.trim());
      const mov = onlyDigits(document.getElementById("mov").value.trim());
      const pontos = onlyDigits(document.getElementById("pontos").value.trim()) || "0";

      return { camisa, nome, apelido, nascimento, celular, posicao, hab, vel, mov, pontos };
    }

    function clearForm(){
      ["camisa","nome","apelido","nascimento","celular","posicao","hab","vel","mov","pontos"].forEach(id=>{
        document.getElementById(id).value = "";
      });
      document.getElementById("pontos").value = "0";
    }

    // ===== RENDER =====
    function renderList(lista){
      // ordena por apelido (como no modelo)
      const rows = [...lista].sort((a,b)=>{
        const aa = (a.apelido||"").toUpperCase();
        const bb = (b.apelido||"").toUpperCase();
        return aa.localeCompare(bb);
      });

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      rows.forEach((p, idx)=>{
        const tr = document.createElement("tr");

        const id = p.id ?? p.ID ?? p._id ?? null;
        const camisa = p.camisa ?? "";
        const apelido = p.apelido ?? "";
        const nome = p.nome ?? "";
        const nascimento = (p.nascimento ?? p.nasc ?? p.data_nasc ?? "").toString();
        const idade = calcIdade(nascimento);
        const celular = p.celular ?? "";
        const posicao = (p.posicao ?? p.pos ?? "").toString();
        const hab = (p.hab ?? "").toString();
        const vel = (p.vel ?? "").toString();
        const mov = (p.mov ?? "").toString();
        const pontos = (p.pontos ?? "0").toString();

        tr.innerHTML = `
          <td class="center">${idx+1}</td>
          <td class="center">${camisa}</td>
          <td>${apelido}</td>
          <td>${nome}</td>
          <td class="center">${nascimento}</td>
          <td class="center">${idade}</td>
          <td>${celular}</td>
          <td class="center">${posicao}</td>
          <td class="center">${hab}</td>
          <td class="center">${vel}</td>
          <td class="center">${mov}</td>
          <td class="center">${pontos}</td>
          <td class="center"><button class="btn-mini btn-edit" data-edit="${encodeURIComponent(apelido)}">EDITAR</button></td>
          <td class="center"><button class="btn-mini btn-del" data-del="${encodeURIComponent(apelido)}">EXCLUIR</button></td>
        `;
        tbody.appendChild(tr);

        // guarda ID se existir
        tr.dataset.id = (id !== null && id !== undefined) ? String(id) : "";
        tr.dataset.apelido = apelido;
      });

      // ações
      tbody.querySelectorAll("[data-edit]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const ap = decodeURIComponent(btn.getAttribute("data-edit"));
          const row = [...tbody.querySelectorAll("tr")].find(r => (r.dataset.apelido||"") === ap);
          if(!row) return;
          // preenche form pelo texto da linha (simples e estável)
          const tds = row.querySelectorAll("td");
          document.getElementById("camisa").value = tds[1].textContent.trim();
          document.getElementById("apelido").value = tds[2].textContent.trim();
          document.getElementById("nome").value = tds[3].textContent.trim();
          document.getElementById("nascimento").value = tds[4].textContent.trim();
          document.getElementById("celular").value = tds[6].textContent.trim();
          document.getElementById("posicao").value = (tds[7].textContent.trim() || "").toUpperCase();
          document.getElementById("hab").value = tds[8].textContent.trim();
          document.getElementById("vel").value = tds[9].textContent.trim();
          document.getElementById("mov").value = tds[10].textContent.trim();
          document.getElementById("pontos").value = tds[11].textContent.trim() || "0";
          setStatusOk("Editando: " + ap);
          // marca edição pelo apelido (mais compatível)
          document.getElementById("btnSalvar").dataset.edit = ap;
        });
      });

      tbody.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const ap = decodeURIComponent(btn.getAttribute("data-del"));
          if(!confirm("Excluir jogador: " + ap + " ?")) return;
          try{
            setStatusOk("Excluindo...");
            // tenta por apelido
            const res = await apiFetch("/" + encodeURIComponent(ap), { method:"DELETE" });
            if(!res.ok){
              const txt = await res.text().catch(()=> "");
              throw new Error("Falha ao excluir: " + res.status + " " + txt);
            }
            await loadList();
            setStatusOk("Excluído: " + ap);
          }catch(e){
            setStatusErr(String(e.message||e));
          }
        });
      });
    }

    function renderBdays(lista){
      const now = new Date();
      const month = now.getMonth() + 1;
      const year = now.getFullYear();

      const itens = (lista||[])
        .map(p=>{
          const apelido = (p.apelido||"").toString();
          const nascimento = (p.nascimento ?? p.nasc ?? p.data_nasc ?? "").toString();
          if(!nascimento || nascimento.length < 10) return null;
          const [y,m,d] = nascimento.split("-").map(Number);
          if(!m || !d) return null;
          if(m !== month) return null;
          const idade = calcIdade(nascimento);
          return { apelido, dia: String(d).padStart(2,"0"), idade };
        })
        .filter(Boolean)
        .sort((a,b)=> Number(a.dia)-Number(b.dia));

      const title = document.getElementById("bdayTitle");
      const months = ["JANEIRO","FEVEREIRO","MARÇO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"];
      title.textContent = `ANIVERSARIANTES DO MÊS - ${months[month-1]} / ${year}`;

      const box = document.getElementById("bdayContent");
      if(!itens.length){
        box.innerHTML = `<div style="color:#9bb0d1;font-weight:900">Nenhum aniversariante neste mês.</div>`;
        return;
      }

      let html = `
        <table class="bday-table">
          <thead>
            <tr><th>APELIDO</th><th>DIA</th><th>IDADE</th></tr>
          </thead>
          <tbody>
      `;
      itens.forEach(x=>{
        html += `<tr><td>${x.apelido}</td><td>${x.dia}</td><td>${x.idade}</td></tr>`;
      });
      html += `</tbody></table>`;
      box.innerHTML = html;
    }

    // ===== SALVAR (cria/edita e sempre recarrega TOTAL) =====
    async function salvar(){
      try{
        const f = getForm();

        if(!f.apelido){
          setStatusErr("ERRO: informe o APELIDO");
          return;
        }

        // valida posição (sem goleiro)
        if(f.posicao && !["Z","L","M","A"].includes(f.posicao)){
          setStatusErr("ERRO: POSIÇÃO inválida (use Z/L/M/A)");
          return;
        }

        setStatusOk("Salvando...");

        const editApelido = (document.getElementById("btnSalvar").dataset.edit || "").trim();

        const payload = {
          camisa: f.camisa,
          apelido: f.apelido,
          nome: f.nome,
          nascimento: f.nascimento,
          celular: f.celular,
          posicao: f.posicao,
          hab: f.hab,
          vel: f.vel,
          mov: f.mov,
          pontos: f.pontos
        };

        let res;
        if(editApelido){
          // update
          res = await apiFetch("/" + encodeURIComponent(editApelido), {
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        }else{
          // create
          res = await apiFetch("", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        }

        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          // Mostra erro real (ex: apelido duplicado)
          throw new Error("Falha ao salvar: " + res.status + " " + txt);
        }

        // sempre recarrega lista pra atualizar TOTAL
        await loadList();

        // limpa modo edição
        document.getElementById("btnSalvar").dataset.edit = "";
        clearForm();
        document.getElementById("pontos").value = "0";

        setStatusOk("OK: salvo e lista atualizada");
      }catch(e){
        setStatusErr(String(e.message||e));
      }
    }

    // ===== INIT =====
    document.getElementById("btnSalvar").addEventListener("click", salvar);
    document.getElementById("btnLimpar").addEventListener("click", ()=>{
      document.getElementById("btnSalvar").dataset.edit = "";
      clearForm();
      document.getElementById("pontos").value = "0";
      setStatusOk("OK: limpo");
    });
    document.getElementById("btnPdf").addEventListener("click", ()=>baixarPdf());

    // força POSIÇÃO 1 letra maiúscula
    document.getElementById("posicao").addEventListener("input", (e)=>{
      e.target.value = (e.target.value || "").toUpperCase().slice(0,1);
    });

    // carrega
    (async ()=>{
      try{
        await loadList();
      }catch(e){
        setStatusErr(String(e.message||e));
      }
    })();
  
// ===== PDF (gera arquivo e baixa) =====
function _loadScriptOnce(id, src){
  return new Promise((resolve, reject)=>{
    if(document.getElementById(id)) return resolve();
    const s = document.createElement("script");
    s.id = id;
    s.src = src;
    s.async = true;
    s.onload = ()=>resolve();
    s.onerror = ()=>reject(new Error("Falha ao carregar: "+src));
    document.head.appendChild(s);
  });
}

async function baixarPdf(){
  const root =
    document.querySelector("#printArea") ||
    document.querySelector(".container") ||
    document.querySelector(".wrap") ||
    document.querySelector("main") ||
    document.body;

  document.body.classList.add("pdf-mode");
  try{
    await _loadScriptOnce(
      "html2pdf-lib",
      "https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"
    );

    const now = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const file = `TESOURA-JOGADORES-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;

    const opt = {
      margin: [8,8,8,8],
      filename: file,
      image: { type: "jpeg", quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
      jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
    };

    await html2pdf().set(opt).from(root).save();
  }catch(e){
    console.error(e);
    alert("Não consegui gerar o PDF automático. Vou abrir o modo Imprimir.");
    window.print();
  }finally{
    document.body.classList.remove("pdf-mode");
  }
}


// ===== R2 PDF (BAIXA ARQUIVO) + TABELA PRINCIPAL (sem barra horizontal) =====
function marcarTabelaPrincipal(){
  try{
    const tables = Array.from(document.querySelectorAll("table"));
    for(const t of tables){
      const th = t.querySelector("thead th");
      const first = (th ? th.textContent : "").toUpperCase();
      if(first.includes("ORD")){ t.classList.add("tbl-main"); break; }
    }
  }catch(e){}
}

async function baixarPdf(){
  try{
    if(typeof html2pdf === "undefined"){
      alert("PDF: biblioteca não carregou. Atualize com Ctrl+F5 e tente de novo.");
      return;
    }

    // tenta pegar o container principal do painel
    const root =
      document.querySelector("#printArea") ||
      document.querySelector(".container") ||
      document.querySelector(".wrap") ||
      document.querySelector("main") ||
      document.body;

    const now = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const file = `TESOURA-JOGADORES-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;

    const opt = {
      margin: [8,8,8,8],
      filename: file,
      image: { type: "jpeg", quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
      jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
    };

    await html2pdf().set(opt).from(root).save(); // <-- ISTO BAIXA O ARQUIVO
  }catch(e){
    console.error(e);
    alert("Falha ao baixar PDF. Veja o console.");
  }
}

// observa mudanças e marca a tabela quando ela aparecer/recarregar
try{
  const obs = new MutationObserver(()=>marcarTabelaPrincipal());
  obs.observe(document.body, { childList:true, subtree:true });
  setTimeout(marcarTabelaPrincipal, 500);
}catch(e){}


// ===== R3: marcar tabela principal (ORD...) como .tbl-main =====
function marcarTabelaPrincipal(){
  try{
    const tables = Array.from(document.querySelectorAll("table"));
    for(const t of tables){
      const th = t.querySelector("thead th");
      const first = (th ? th.textContent : "").toUpperCase();
      if(first.includes("ORD")){
        t.classList.add("tbl-main");
        break;
      }
    }
  }catch(e){}
}
try{
  const obs = new MutationObserver(()=>marcarTabelaPrincipal());
  obs.observe(document.body, { childList:true, subtree:true });
  setTimeout(marcarTabelaPrincipal, 300);
}catch(e){}


// ===== R3 PDF: BAIXAR ARQUIVO (sem print) =====
async function baixarPdf(){
  try{
    if(typeof html2pdf === "undefined"){
      alert("PDF: biblioteca não carregou. Faça Ctrl+F5 e tente de novo.");
      return;
    }
    const root =
      document.querySelector("#printArea") ||
      document.querySelector(".container") ||
      document.querySelector(".wrap") ||
      document.querySelector("main") ||
      document.body;

    const now = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    const file = `TESOURA-JOGADORES-${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}.pdf`;

    const opt = {
      margin: [8,8,8,8],
      filename: file,
      image: { type: "jpeg", quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" },
      jsPDF: { unit: "mm", format: "a4", orientation: "landscape" }
    };

    await html2pdf().set(opt).from(root).save(); // BAIXA o PDF
  }catch(e){
    console.error(e);
    alert("Falha ao baixar PDF. Veja o console.");
  }
}

</script>
</body>
</html>
