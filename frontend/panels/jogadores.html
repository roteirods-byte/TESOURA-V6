<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TESOURA - JOGADORES</title>

  <style>
    :root{
      --bg:#07101c;
      --card:#0b1526;
      --card2:#0a1322;
      --line:#243249;
      --txt:#e8eefc;
      --muted:#a9b6cf;
      --orange:#ff7a00;
      --green:#22c55e;
      --red:#ff4d4d;
      --blue:#27b0ff;

      /* larguras (SEU ESQUEMA) - FORM */
      --w-camisa:70px;
      --w-apelido:140px;
      --w-nome:220px;
      --w-nasc:110px;
      --w-cel:140px;
      --w-pos:60px;
      --w-hab:60px;
      --w-vel:60px;
      --w-mov:60px;
      --w-pontos:60px;

      --w-btn:110px;

      /* BDAY */
      --w-bday-apel:100px;
      --w-bday-data:60px;
      --w-bday-idade:60px;

      /* TABELA (SEU ESQUEMA) */
      --t-ordem:60px;
      --t-camisa:70px;
      --t-apelido:140px;
      --t-nome:220px;
      --t-nasc:110px;
      --t-idade:70px;
      --t-cel:140px;
      --t-pos:60px;
      --t-hab:60px;
      --t-vel:60px;
      --t-mov:60px;
      --t-pontos:60px;
      --t-editar:110px;
      --t-excluir:110px;

      --radius:14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:transparent;
      color:var(--txt);
    }

    .container{
      padding:14px 16px 18px;
    }

    h1{
      margin:0 0 6px 0;
      font-size:20px;
      color:var(--orange);
      letter-spacing:.4px;
    }

    .rev{
      color:var(--green);
      font-weight:900;
      margin:0 0 10px 0;
      font-size:13px;
    }

    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
    }

    .helpbar{
      display:flex;
      gap:18px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--txt);
      opacity:.95;
      margin-bottom:10px;
      font-weight:800;
    }

    /* FORM GRID (compacto) */
    .formGrid{
      display:grid;
      grid-template-columns:
        var(--w-camisa)
        var(--w-nome)
        var(--w-apelido)
        var(--w-nasc)
        var(--w-cel)
        var(--w-pos)
        var(--w-hab)
        var(--w-vel)
        var(--w-mov)
        var(--w-pontos)
        var(--w-btn)
        var(--w-btn)
        var(--w-btn);
      gap:10px 10px;
      align-items:end;
    }

    .field label{
      display:block;
      font-size:11px;
      color:var(--txt);
      opacity:.9;
      margin:0 0 5px 2px;
      font-weight:800;
      letter-spacing:.2px;
    }

    input{
      width:100%;
      height:34px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#0a1220;
      color:var(--txt);
      padding:7px 10px;
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color:#8ea0bf; }

    .btn{
      height:34px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.3px;
      font-size:12px;
    }
    .btnSave{ background:var(--green); color:#07101c; }
    .btnClear{ background:var(--orange); color:#07101c; }
    .btnPdf{ background:var(--blue); color:#07101c; }

    .statusRow{
      margin-top:10px;
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
      font-size:13px;
    }
    .ok{ color:var(--green); font-weight:900; }
    .err{ color:var(--red); font-weight:900; }

    /* BDAY */
    .bdayCard{
      margin-top:12px;
      background:linear-gradient(180deg,#0b1526,#081120);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
    }
    .bdayTitle{
      color:var(--orange);
      font-weight:900;
      font-size:13px;
      margin-bottom:8px;
      letter-spacing:.4px;
    }
    table{ border-collapse:collapse; width:100%; }
    .bdayTable th,.bdayTable td{
      border:1px solid var(--line);
      padding:6px 8px;
      font-size:12px;
      text-align:left;
    }
    .bdayTable th{ color:var(--orange); font-weight:900; }
    .bdayTable td{ color:var(--txt); font-weight:700; }
    .bdayCols col:nth-child(1){ width:var(--w-bday-apel); }
    .bdayCols col:nth-child(2){ width:var(--w-bday-data); }
    .bdayCols col:nth-child(3){ width:var(--w-bday-idade); }

    /* LISTA */
    .listCard{
      margin-top:12px;
      background:linear-gradient(180deg,#0b1526,#081120);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:10px;
      overflow:auto;
      max-height:420px;
    }

    .tbl th,.tbl td{
      border:1px solid var(--line);
      padding:8px 8px;
      font-size:12px;
      text-align:left;
      white-space:nowrap;
    }
    .tbl th{
      background:#07101c;
      color:var(--orange);
      font-weight:900;
    }
    .tbl td{ color:var(--txt); font-weight:700; }

    .tbl colgroup col:nth-child(1){ width:var(--t-ordem); }
    .tbl colgroup col:nth-child(2){ width:var(--t-camisa); }
    .tbl colgroup col:nth-child(3){ width:var(--t-apelido); }
    .tbl colgroup col:nth-child(4){ width:var(--t-nome); }
    .tbl colgroup col:nth-child(5){ width:var(--t-nasc); }
    .tbl colgroup col:nth-child(6){ width:var(--t-idade); }
    .tbl colgroup col:nth-child(7){ width:var(--t-cel); }
    .tbl colgroup col:nth-child(8){ width:var(--t-pos); }
    .tbl colgroup col:nth-child(9){ width:var(--t-hab); }
    .tbl colgroup col:nth-child(10){ width:var(--t-vel); }
    .tbl colgroup col:nth-child(11){ width:var(--t-mov); }
    .tbl colgroup col:nth-child(12){ width:var(--t-pontos); }
    .tbl colgroup col:nth-child(13){ width:var(--t-editar); }
    .tbl colgroup col:nth-child(14){ width:var(--t-excluir); }

    .miniBtn{
      height:30px;
      border-radius:10px;
      border:0;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      padding:0 14px;
    }
    .miniEdit{ background:var(--blue); color:#07101c; }
    .miniDel{ background:var(--red); color:#07101c; }

    /* PRINT / PDF */
    @media print{
      body{ background:#fff !important; }
      .noPrint{ display:none !important; }
      .container{ padding:0; }
      .card,.bdayCard,.listCard{ box-shadow:none; }
      @page { size: A4 landscape; margin: 10mm; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>TESOURA - JOGADORES</h1>
    <div class="rev" id="revLine">REV JOGADORES: 16/01 11:25</div>

    <div class="card">
      <div class="helpbar">
        <span>POSIÇÃO (Z/L/M/A): ZAGUEIRO / LATERAL / MEIO / ATAQUE</span>
        <span>HABILIDADE (1–5)</span>
        <span>VELOCIDADE (1–L, 2–N, 3–I)</span>
        <span>MOVIMENTAÇÃO (1–P, 2–N, 3–I)</span>
      </div>

      <div class="noPrint">
        <div class="formGrid">
          <div class="field">
            <label>CAMISA</label>
            <input id="camisa" placeholder="Nº" inputmode="numeric" />
          </div>

          <div class="field">
            <label>NOME</label>
            <input id="nome" placeholder="Nome completo" />
          </div>

          <div class="field">
            <label>APELIDO (ÚNICO)*</label>
            <input id="apelido" placeholder="Apelido" />
          </div>

          <div class="field">
            <label>NASCIMENTO</label>
            <input id="nasc" placeholder="AAAA-MM-DD" />
          </div>

          <div class="field">
            <label>CELULAR</label>
            <input id="celular" placeholder="DDD + número" />
          </div>

          <div class="field">
            <label>POSIÇÃO (Z/L/M/A)</label>
            <input id="posicao" placeholder="Z/L/M/A" maxlength="1" />
          </div>

          <div class="field">
            <label>HABILIDADE (1–5)</label>
            <input id="hab" placeholder="1-5" inputmode="numeric" />
          </div>

          <div class="field">
            <label>VELOCIDADE (1–3)</label>
            <input id="vel" placeholder="1-3" inputmode="numeric" />
          </div>

          <div class="field">
            <label>MOVIMENTAÇÃO (1–3)</label>
            <input id="mov" placeholder="1-3" inputmode="numeric" />
          </div>

          <div class="field">
            <label>PONTOS</label>
            <input id="pontos" placeholder="0" inputmode="numeric" />
          </div>

          <button class="btn btnSave" id="btnSalvar">SALVAR</button>
          <button class="btn btnClear" id="btnLimpar">LIMPAR</button>
          <button class="btn btnPdf" id="btnPdf">BAIXAR PDF</button>
        </div>

        <div class="statusRow">
          <span id="msg" class="ok">OK: carregando...</span>
          <span id="totalTxt" class="muted" style="color:var(--txt);font-weight:900;">TOTAL DE JOGADORES: 0</span>
        </div>
      </div>

      <div class="bdayCard">
        <div class="bdayTitle" id="bdayTitle">ANIVERSARIANTES DO MÊS</div>
        <div id="bdayWrap"></div>
      </div>

      <div class="listCard">
        <table class="tbl" id="tbl">
          <colgroup>
            <col><col><col><col><col><col><col><col><col><col><col><col><col><col>
          </colgroup>
          <thead>
            <tr>
              <th>ORDEM</th>
              <th>CAMISA</th>
              <th>APELIDO</th>
              <th>NOME</th>
              <th>DATA NASC.</th>
              <th>IDADE</th>
              <th>CELULAR</th>
              <th>POSIÇÃO</th>
              <th>HAB</th>
              <th>VEL</th>
              <th>MOV</th>
              <th>PONTOS</th>
              <th>EDITAR</th>
              <th>EXCLUIR</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const msg = $("msg");
  const totalTxt = $("totalTxt");
  const bdayWrap = $("bdayWrap");
  const tbody = $("tbody");

  const inputs = {
    camisa: $("camisa"),
    nome: $("nome"),
    apelido: $("apelido"),
    nasc: $("nasc"),
    celular: $("celular"),
    posicao: $("posicao"),
    hab: $("hab"),
    vel: $("vel"),
    mov: $("mov"),
    pontos: $("pontos"),
  };

  let editingId = null;
  let jogadores = [];
  let apiBase = "/api/jogadores"; // padrão
  let apiMode = "rest"; // rest ou bodyId (fallback)

  function setOK(text){ msg.className="ok"; msg.textContent=text; }
  function setERR(text){ msg.className="err"; msg.textContent=text; }

  function onlyInt(v){
    const n = String(v ?? "").trim();
    if(n==="") return "";
    const x = n.replace(/[^\d\-]/g,"");
    return x;
  }

  function upper1(v){
    return (String(v ?? "").trim().toUpperCase().slice(0,1));
  }

  function parseDateISO(v){
    const s = String(v ?? "").trim();
    if(!s) return "";
    // aceita AAAA-MM-DD ou DD/MM/AAAA
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return `${m[3]}-${m[2]}-${m[1]}`;
    return s; // deixa como veio
  }

  function calcAge(iso){
    if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return "";
    const [y,m,d] = iso.split("-").map(Number);
    const birth = new Date(y, m-1, d);
    const now = new Date();
    let age = now.getFullYear() - birth.getFullYear();
    const md = (now.getMonth()+1)*100 + now.getDate();
    const bd = (m)*100 + d;
    if(md < bd) age--;
    return age;
  }

  function cleanPlayer(p){
    // tolera vários formatos vindos do backend
    const id = p.id ?? p.ID ?? p._id ?? p.uuid ?? null;
    const camisa = p.camisa ?? p.CAMISA ?? "";
    const apelido = p.apelido ?? p.APELIDO ?? "";
    const nome = p.nome ?? p.NOME ?? "";
    const nasc = p.nasc ?? p.nascimento ?? p.data_nasc ?? p.dataNascimento ?? p.NASC ?? "";
    const celular = p.celular ?? p.CELULAR ?? "";
    const posicao = p.posicao ?? p.POSICAO ?? "";
    const hab = p.hab ?? p.HAB ?? "";
    const vel = p.vel ?? p.VEL ?? "";
    const mov = p.mov ?? p.MOV ?? "";
    const pontos = p.pontos ?? p.PONTOS ?? 0;
    return {
      id,
      camisa: String(camisa ?? ""),
      apelido: String(apelido ?? ""),
      nome: String(nome ?? ""),
      nasc: String(nasc ?? ""),
      celular: String(celular ?? ""),
      posicao: String(posicao ?? ""),
      hab: String(hab ?? ""),
      vel: String(vel ?? ""),
      mov: String(mov ?? ""),
      pontos: String(pontos ?? "0"),
    };
  }

  async function tryJson(url){
    try{
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) return null;
      const ct = (r.headers.get("content-type")||"").toLowerCase();
      if(!ct.includes("application/json")) return null;
      const data = await r.json();
      if(Array.isArray(data)) return data;
      if(Array.isArray(data.lista)) return data.lista;
      if(Array.isArray(data.data)) return data.data;
      return null;
    }catch(e){
      return null;
    }
  }

  async function detectApi(){
    const candidates = [
      "/api/jogadores",
      "/api/players",
      "/api/jogadores/list",
    ];
    for(const c of candidates){
      const data = await tryJson(c);
      if(data && data.length >= 0){
        apiBase = c.replace(/\/list$/,"");
        setOK("OK: lista carregada");
        return;
      }
    }
    // se nada funcionar, mantém padrão e mostra erro amigável
    setERR("ERRO: API de jogadores não encontrada (/api/jogadores).");
  }

  function validateForm(){
    const apelido = String(inputs.apelido.value||"").trim();
    if(!apelido) return "Informe o APELIDO.";

    const pos = upper1(inputs.posicao.value);
    if(pos && !["Z","L","M","A"].includes(pos)) return "POSIÇÃO inválida. Use Z/L/M/A.";

    const hab = onlyInt(inputs.hab.value);
    const vel = onlyInt(inputs.vel.value);
    const mov = onlyInt(inputs.mov.value);

    if(hab && (+hab < 1 || +hab > 5)) return "HABILIDADE deve ser 1–5.";
    if(vel && (+vel < 1 || +vel > 3)) return "VELOCIDADE deve ser 1–3.";
    if(mov && (+mov < 1 || +mov > 3)) return "MOVIMENTAÇÃO deve ser 1–3.";

    // apelido duplicado (front)
    const key = apelido.toLowerCase();
    const dup = jogadores.find(j => (j.apelido||"").toLowerCase()===key && String(j.id||"") !== String(editingId||""));
    if(dup) return "APELIDO duplicado. Use outro.";

    return "";
  }

  function readForm(){
    return {
      id: editingId,
      camisa: onlyInt(inputs.camisa.value),
      apelido: String(inputs.apelido.value||"").trim(),
      nome: String(inputs.nome.value||"").trim(),
      nasc: parseDateISO(inputs.nasc.value),
      celular: String(inputs.celular.value||"").trim(),
      posicao: upper1(inputs.posicao.value),
      hab: onlyInt(inputs.hab.value),
      vel: onlyInt(inputs.vel.value),
      mov: onlyInt(inputs.mov.value),
      pontos: onlyInt(inputs.pontos.value) || "0",
    };
  }

  function fillForm(p){
    inputs.camisa.value = p.camisa || "";
    inputs.apelido.value = p.apelido || "";
    inputs.nome.value = p.nome || "";
    inputs.nasc.value = parseDateISO(p.nasc || "");
    inputs.celular.value = p.celular || "";
    inputs.posicao.value = upper1(p.posicao || "");
    inputs.hab.value = p.hab || "";
    inputs.vel.value = p.vel || "";
    inputs.mov.value = p.mov || "";
    inputs.pontos.value = p.pontos ?? "0";
  }

  function clearForm(){
    editingId = null;
    Object.values(inputs).forEach(i => i.value = "");
    inputs.pontos.value = "0";
    setOK("OK: pronto");
  }

  async function apiCall(url, opts){
    const r = await fetch(url, Object.assign({ cache:"no-store" }, opts));
    const text = await r.text().catch(()=> "");
    let json = null;
    try{ json = text ? JSON.parse(text) : null; }catch(_){}
    return { ok:r.ok, status:r.status, text, json };
  }

  async function savePlayer(payload){
    // tenta alguns formatos (para encaixar no seu backend sem você mexer nele)
    const body = JSON.stringify(payload);

    // 1) REST comum: POST /api/jogadores  (novo)
    if(!payload.id){
      let a = await apiCall(apiBase, { method:"POST", headers:{ "content-type":"application/json" }, body });
      if(a.ok) return a;

      // fallback: POST /api/jogadores/add
      a = await apiCall(apiBase + "/add", { method:"POST", headers:{ "content-type":"application/json" }, body });
      if(a.ok) return a;

      // fallback: PUT /api/jogadores (alguns backends usam)
      a = await apiCall(apiBase, { method:"PUT", headers:{ "content-type":"application/json" }, body });
      return a;
    }

    // 2) update: PUT /api/jogadores/:id
    let u = await apiCall(apiBase + "/" + encodeURIComponent(payload.id), { method:"PUT", headers:{ "content-type":"application/json" }, body });
    if(u.ok) return u;

    // fallback: PUT /api/jogadores (com id no body)
    u = await apiCall(apiBase, { method:"PUT", headers:{ "content-type":"application/json" }, body });
    return u;
  }

  async function deletePlayer(id){
    // 1) DELETE /api/jogadores/:id
    let d = await apiCall(apiBase + "/" + encodeURIComponent(id), { method:"DELETE" });
    if(d.ok) return d;

    // fallback: POST /api/jogadores/delete
    d = await apiCall(apiBase + "/delete", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ id }) });
    return d;
  }

  function renderTotal(){
    totalTxt.textContent = "TOTAL DE JOGADORES: " + jogadores.length;
  }

  function renderTable(){
    tbody.innerHTML = "";

    const sorted = [...jogadores].sort((a,b)=> (a.apelido||"").localeCompare((b.apelido||""), "pt-BR", { sensitivity:"base" }));

    sorted.forEach((p, idx) => {
      const iso = parseDateISO(p.nasc);
      const idade = calcAge(iso);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${p.camisa||""}</td>
        <td>${(p.apelido||"").toUpperCase()}</td>
        <td>${p.nome||""}</td>
        <td>${iso||""}</td>
        <td>${idade||""}</td>
        <td>${p.celular||""}</td>
        <td>${upper1(p.posicao||"")}</td>
        <td>${p.hab||""}</td>
        <td>${p.vel||""}</td>
        <td>${p.mov||""}</td>
        <td>${p.pontos||"0"}</td>
        <td><button class="miniBtn miniEdit">EDITAR</button></td>
        <td><button class="miniBtn miniDel">EXCLUIR</button></td>
      `;

      tr.querySelector(".miniEdit").onclick = () => {
        editingId = p.id;
        fillForm(p);
        setOK("OK: editando " + (p.apelido||""));
        window.scrollTo({ top:0, behavior:"smooth" });
      };

      tr.querySelector(".miniDel").onclick = async () => {
        if(!p.id){
          setERR("ERRO: este jogador não tem ID (backend precisa enviar id).");
          return;
        }
        if(!confirm("Excluir o jogador: " + (p.apelido||"") + " ?")) return;
        setOK("OK: excluindo...");
        const res = await deletePlayer(p.id);
        if(!res.ok){
          setERR("ERRO ao excluir ("+res.status+"): " + (res.json?.error || res.text || "falha"));
          return;
        }
        await loadPlayers();
        setOK("OK: excluído");
      };

      tbody.appendChild(tr);
    });
  }

  function renderBday(){
    const now = new Date();
    const month = now.getMonth()+1;

    const list = jogadores
      .map(cleanPlayer)
      .map(p => ({...p, iso: parseDateISO(p.nasc)}))
      .filter(p => /^\d{4}-\d{2}-\d{2}$/.test(p.iso))
      .filter(p => (Number(p.iso.slice(5,7)) === month))
      .sort((a,b)=> a.iso.localeCompare(b.iso));

    const monthName = now.toLocaleDateString("pt-BR", { month:"long" }).toUpperCase();
    $("bdayTitle").textContent = `ANIVERSARIANTES DO MÊS - ${monthName} / ${now.getFullYear()}`;

    if(list.length === 0){
      bdayWrap.innerHTML = `<div style="color:var(--muted);font-weight:800;">Nenhum aniversariante neste mês.</div>`;
      return;
    }

    let html = `
      <table class="bdayTable">
        <colgroup class="bdayCols"><col><col><col></colgroup>
        <thead><tr><th>APELIDO</th><th>DATA</th><th>IDADE</th></tr></thead>
        <tbody>
    `;
    for(const p of list){
      const ddmm = p.iso.slice(8,10) + "/" + p.iso.slice(5,7);
      html += `<tr>
        <td>${(p.apelido||"").toUpperCase()}</td>
        <td style="text-align:center">${ddmm}</td>
        <td style="text-align:center">${calcAge(p.iso)}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    bdayWrap.innerHTML = html;
  }

  async function loadPlayers(){
    setOK("OK: carregando...");
    const data = await tryJson(apiBase) || [];
    jogadores = (data || []).map(cleanPlayer);
    renderTotal();
    renderBday();
    renderTable();
    setOK("OK: lista carregada");
  }

  // eventos
  $("btnLimpar").onclick = () => clearForm();
  $("btnPdf").onclick = () => window.print();

  $("btnSalvar").onclick = async () => {
    const err = validateForm();
    if(err){ setERR("ERRO: " + err); return; }

    const payload = readForm();
    setOK("OK: salvando...");

    const res = await savePlayer(payload);
    if(!res.ok){
      setERR("ERRO ao salvar ("+res.status+"): " + (res.json?.error || res.text || "falha"));
      return;
    }

    // recarrega lista e atualiza TOTAL
    await loadPlayers();
    clearForm();
    setOK("OK: salvo");
  };

  // normalizações rápidas
  inputs.posicao.addEventListener("input", () => { inputs.posicao.value = upper1(inputs.posicao.value); });
  inputs.apelido.addEventListener("blur", () => { inputs.apelido.value = String(inputs.apelido.value||"").trim(); });

  // start
  (async () => {
    await detectApi();
    await loadPlayers();
  })();

})();
</script>

</body>
</html>
